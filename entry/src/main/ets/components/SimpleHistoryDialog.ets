import { SimpleHistoryItem, HistoryManager } from '../utils/HistoryManager';
import { HouseInputModel } from '../model/HouseInputModel';

/**
 * åŸºç¡€è¯„ä¼°å™¨å†å²è®°å½•å¯¹è¯æ¡†
 */
@CustomDialog
export struct SimpleHistoryDialog {
  @State historyList: SimpleHistoryItem[] = [];
  @State loading: boolean = true;
  
  onLoad?: (item: SimpleHistoryItem) => void;
  onClose?: () => void;
  controller?: CustomDialogController;

  aboutToAppear() {
    this.loadHistory();
  }

  /**
   * åŠ è½½å†å²è®°å½•
   */
  async loadHistory() {
    this.loading = true;
    try {
      const context = getContext(this) as Context;
      this.historyList = await HistoryManager.getSimpleHistory(context);
    } catch (error) {
      console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
    } finally {
      this.loading = false;
    }
  }

  /**
   * åˆ é™¤è®°å½•
   */
  async deleteHistory(id: string) {
    const context = getContext(this) as Context;
    await HistoryManager.deleteSimpleHistory(context, id);
    await this.loadHistory();
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰è®°å½•
   */
  async clearAll() {
    const context = getContext(this) as Context;
    await HistoryManager.clearSimpleHistory(context);
    await this.loadHistory();
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('å†å²è®°å½•')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
        
        // æ¸…ç©ºæŒ‰é’®
        if (this.historyList.length > 0) {
          Button('æ¸…ç©º')
            .fontSize(14)
            .backgroundColor('#FF5252')
            .height(32)
            .margin({ right: 8 })
            .onClick(() => {
              AlertDialog.show({
                title: 'ç¡®è®¤æ¸…ç©º',
                message: 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—?',
                primaryButton: {
                  value: 'å–æ¶ˆ',
                  action: () => {}
                },
                secondaryButton: {
                  value: 'æ¸…ç©º',
                  fontColor: '#FF5252',
                  action: () => {
                    this.clearAll();
                  }
                }
              });
            })
        }
        
        Button('âœ•')
          .width(32)
          .height(32)
          .backgroundColor(Color.Transparent)
          .fontColor($r('app.color.text_secondary'))
          .onClick(() => {
            if (this.onClose) {
              this.onClose();
            }
          })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 20, bottom: 15 })

      Divider()

      // å†…å®¹åŒºåŸŸ
      if (this.loading) {
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .margin({ top: 50 })
          
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 10 })
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
      } else if (this.historyList.length === 0) {
        Column() {
          Text('ğŸ“')
            .fontSize(48)
            .margin({ bottom: 10 })
          
          Text('æš‚æ— å†å²è®°å½•')
            .fontSize(16)
            .fontColor($r('app.color.text_secondary'))
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
      } else {
        List({ space: 0 }) {
          ForEach(this.historyList, (item: SimpleHistoryItem) => {
            ListItem() {
              this.buildHistoryItem(item)
            }
          })
        }
        .width('100%')
        .height(400)
        .divider({ strokeWidth: 1, color: $r('app.color.divider_color') })
      }
    }
    .width('90%')
    .constraintSize({ maxWidth: 600, maxHeight: 550 })
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({
      radius: 20,
      color: '#00000030',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder
  buildHistoryItem(item: SimpleHistoryItem) {
    Row() {
      Column() {
        // åç§°å’Œæ—¶é—´
        Text(item.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        
        Row({ space: 8 }) {
          Text(item.cityName)
            .fontSize(12)
            .fontColor($r('app.color.text_secondary'))
          
          Text('|')
            .fontSize(12)
            .fontColor($r('app.color.divider_color'))
          
          Text(this.formatTimestamp(item.timestamp))
            .fontSize(12)
            .fontColor($r('app.color.text_secondary'))
        }
        .margin({ top: 4 })
        
        // å…³é”®æ•°æ®
        Row({ space: 12 }) {
          Text(`å†¬è‡³: ${item.winterSolsticeSunshine.toFixed(1)}h`)
            .fontSize(12)
            .fontColor(item.winterSolsticeSunshine >= 2 ? '#4CAF50' : '#FF5252')
          
          Text(`å¤§å¯’: ${item.greatColdSunshine.toFixed(1)}h`)
            .fontSize(12)
            .fontColor(item.greatColdSunshine >= 2 ? '#4CAF50' : '#FF5252')
          
          Text(`${item.score}åˆ†`)
            .fontSize(12)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getScoreColor(item.score))
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .backgroundColor(this.getScoreColor(item.score) + '20')
            .borderRadius(3)
        }
        .margin({ top: 6 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .padding({ left: 15, top: 12, bottom: 12 })

      // æ“ä½œæŒ‰é’®
      Row({ space: 8 }) {
        Button('åŠ è½½')
          .fontSize(13)
          .height(32)
          .backgroundColor('#1976D2')
          .onClick(() => {
            if (this.onLoad) {
              this.onLoad(item);
            }
          })
        
        Button('åˆ é™¤')
          .fontSize(13)
          .height(32)
          .backgroundColor(Color.Transparent)
          .fontColor('#FF5252')
          .border({ width: 1, color: '#FF5252' })
          .onClick(() => {
            AlertDialog.show({
              title: 'ç¡®è®¤åˆ é™¤',
              message: `ç¡®å®šè¦åˆ é™¤"${item.name}"å—?`,
              primaryButton: {
                value: 'å–æ¶ˆ',
                action: () => {}
              },
              secondaryButton: {
                value: 'åˆ é™¤',
                fontColor: '#FF5252',
                action: () => {
                  this.deleteHistory(item.id);
                }
              }
            });
          })
      }
      .padding({ right: 15 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .onClick(() => {
      // ç‚¹å‡»æ•´è¡Œä¹Ÿå¯ä»¥åŠ è½½
      if (this.onLoad) {
        this.onLoad(item);
      }
    })
  }

  /**
   * è·å–è¯„åˆ†é¢œè‰²
   */
  // æ ¼å¼åŒ–æ—¶é—´æˆ³
  private formatTimestamp(timestamp: number): string {
    const date = new Date(timestamp);
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const hour = date.getHours().toString().padStart(2, '0');
    const minute = date.getMinutes().toString().padStart(2, '0');
    return `${month}-${day} ${hour}:${minute}`;
  }
  
  private getScoreColor(score: number): string {
    if (score >= 85) return '#4CAF50';
    if (score >= 70) return '#8BC34A';
    if (score >= 55) return '#FFC107';
    if (score >= 40) return '#FF9800';
    return '#F44336';
  }
}
