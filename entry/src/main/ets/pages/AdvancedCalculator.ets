import { BuildingModel } from '../model/BuildingModel';
import { AdvancedSunshineCalculator, UnitSunshineResult } from '../calculator/AdvancedSunshineCalculator';
import { UnitSunshineData } from '../model/UnitSunshineData';
// import { UnitSunshineCalculator } from '../calculator/UnitSunshineCalculator';
import { Building3DView } from '../components/Building3DView';
import { UnitSunshineTable } from '../components/UnitSunshineTable';
import { CityModel } from '../model/CityModel';
import { CityDataService } from '../utils/CityDataService';
import { SunshineRatingSystem, RatingResult, SpecialDays } from '../utils/SunshineRatingSystem';
import { SunshineRatingCard } from '../components/SunshineRatingCard';
import { SunshineCharts } from '../components/SunshineCharts';
import { HistoryManager, AdvancedHistoryItem, BuildingJSON } from '../utils/HistoryManager';
import { AdvancedHistoryDialog } from '../components/AdvancedHistoryDialog';
import { SaveHistoryDialog } from '../components/SaveHistoryDialog';
import preferences from '@ohos.data.preferences';
import fs from '@ohos.file.fs';
import picker from '@ohos.file.picker';
import promptAction from '@ohos.promptAction';

/**
 * ä¸‹æ‹‰é€‰é¡¹ç±»å‹
 */
interface SelectOption {
  value: string;
}

/**
 * å»ºç­‘æ•°æ®å¯¼å‡ºæ ¼å¼
 */
interface BuildingExportData {
  version: string;  // æ•°æ®æ ¼å¼ç‰ˆæœ¬
  latitude: number;
  longitude: number;
  scaleMetersPerCell: number;
  nextBuildingId: number;
  buildings: BuildingJSON[];
}

/**
 * å»ºç­‘ç‰©å•å…ƒç‚¹å‡»ç»“æœ
 */
interface BuildingUnitHitResult {
  building: BuildingModel;
  unit: number;
}

/**
 * 3Dåæ ‡ç‚¹
 */
interface Point3D {
  x: number;
  y: number;
  z: number;
}

/**
 * 2Dåæ ‡ç‚¹
 */
interface Point2D {
  x: number;
  y: number;
}

/**
 * é«˜çº§æ—¥ç…§è¯„ä¼°å™¨é¡µé¢
 */
@Entry
@Component
struct AdvancedCalculatorPage {
  @State buildings: BuildingModel[] = [];
  @State selectedBuildingId: number | null = null;
  @State viewMode: string = '2d'; // '2d' æˆ– '3d'
  @State latitude: number = 31.684327;
  @State longitude: number = 118.510117;
  @State scaleMetersPerCell: number = 10; // æ¯æ ¼ä»£è¡¨çš„ç±³æ•°
  @State showResult: boolean = false;
  @State calculating: boolean = false;
  @State calculationResult: UnitSunshineResult | null = null;
  @State ratingResult: RatingResult | null = null;
  
  // åŸå¸‚é€‰æ‹©
  @State selectedCity: string = 'è¯·é€‰æ‹©åŸå¸‚';
  @State cities: CityModel[] = [];
  private cityDialogController: CustomDialogController | null = null;
  
  // å†å²è®°å½•
  private historyDialogController: CustomDialogController | null = null;
  private saveHistoryDialogController: CustomDialogController | null = null;
  
  // å•å…ƒæ—¥ç…§æ•°æ®(ç”¨äº3Dè§†å›¾å’Œè¡¨æ ¼)
  @State unitSunshineData: UnitSunshineData[] = [];
  @State showUnitView: boolean = false;
  @State activeUnitView: 'table' | '3d' = 'table';
  
  // è®¡ç®—ç›®æ ‡
  @State targetBuildingId: number = 1;
  @State targetFloor: number = 1;
  @State targetUnit: number = 1;
  @State targetBuildingOptions: string[] = [];
  @State targetFloorOptions: string[] = [];
  @State targetUnitOptions: string[] = [];
  
  // è®¡ç®—è¿›åº¦
  @State calculationProgress: string = '';
  @State totalUnitsToCalculate: number = 0;
  @State calculatedUnits: number = 0;

  private calculator: AdvancedSunshineCalculator = new AdvancedSunshineCalculator();

  // Canvasç»˜å›¾ç›¸å…³
  @State canvasWidth: number = 800;
  @State canvasHeight: number = 600;
  private canvasSettings: RenderingContextSettings = new RenderingContextSettings(true);
  private canvasContext: CanvasRenderingContext2D = new CanvasRenderingContext2D(this.canvasSettings);
  
  // å»ºç­‘æ”¾ç½®çŠ¶æ€
  @State isPlacingBuilding: boolean = false;
  private nextBuildingId: number = 1;
  private alreadySetTheStatus: boolean = false;
  
  // å“åº”å¼å¸ƒå±€
  @State isSmallScreen: boolean = false;
  @State showControlPanel: boolean = true;
  @StorageLink('isDarkMode') @Watch('onThemeChange') isDarkMode: boolean = false;
  
  // Canvas é¢œè‰² - ä»èµ„æºè¯»å–
  @State canvasBackgroundColor: string = '#FFFFFF';
  @State canvasGridColor: string = '#E0E0E0';
  @State canvasBuildingColor: string = '#90CAF9';
  @State canvasBuildingSelectedColor: string = '#64B5F6';
  @State canvasBuildingBorderColor: string = '#1976D2';
  @State canvasTextColor: string = '#FFFFFF';
  @State canvasAccentColor: string = '#FF6B00';
  
  // èŠ‚æµæ§åˆ¶
  private lastRedrawTime: number = 0;
  private readonly REDRAW_THROTTLE_MS = 16; // çº¦60fps
  
  // å»ºç­‘ç‰©ç¼–è¾‘å‚æ•°
  @State pendingWidth: number = 54;  // ç±³
  @State pendingLength: number = 10;  // ç±³
  @State pendingHeight: number = 60;  // ç±³
  @State pendingFloorHeight: number = 3;  // ç±³
  @State pendingUnits: number = 4;
  @State pendingRotation: number = 0;  // åº¦
  
  // æ‹–åŠ¨çŠ¶æ€
  private isDragging: boolean = false;
  private dragStartX: number = 0;
  private dragStartY: number = 0;
  private dragBuildingStartX: number = 0;
  private dragBuildingStartY: number = 0;
  
  // é¢„è§ˆä½ç½®
  @State previewX: number = 0;
  @State previewY: number = 0;
  @State showPreview: boolean = false;
  
  // æ•°æ®æŒä¹…åŒ–
  private readonly STORAGE_KEY = 'advanced_calculator_data';

  async aboutToAppear() {
    // åˆå§‹åŒ–åŸå¸‚æ•°æ®
    this.cities = CityDataService.getAllCities();
    // åŠ è½½ä¸Šæ¬¡ä¿å­˜çš„æ•°æ®
    this.loadFromStorage();
    // æ£€æµ‹å±å¹•å°ºå¯¸
    this.checkScreenSize();
    // åŠ è½½Canvasé¢œè‰²
    await this.loadCanvasColors();
  }
  
  /**
   * åŠ è½½Canvasé¢œè‰²èµ„æº
   */
  private async loadCanvasColors() {
    try {
      const resourceManager = this.getUIContext().getHostContext()?.resourceManager;
      if (!resourceManager) {
        console.error('ResourceManager is not available');
        return;
      }

      // ä½¿ç”¨getColorè·å–é¢œè‰²æ•°å€¼,ç„¶åè½¬æ¢ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²
      const bgColor = await resourceManager.getColor($r('app.color.canvas_background').id);
      const gridColor = await resourceManager.getColor($r('app.color.canvas_grid').id);
      const buildingColor = await resourceManager.getColor($r('app.color.canvas_building').id);
      const buildingSelectedColor = await resourceManager.getColor($r('app.color.canvas_building_selected').id);
      const buildingBorderColor = await resourceManager.getColor($r('app.color.canvas_building_border').id);
      const textColor = await resourceManager.getColor($r('app.color.canvas_text').id);
      const accentColor = await resourceManager.getColor($r('app.color.canvas_accent').id);

      // è½¬æ¢ä¸ºCanvaså¯ç”¨çš„é¢œè‰²å­—ç¬¦ä¸²æ ¼å¼
      this.canvasBackgroundColor = this.colorToHex(bgColor);
      this.canvasGridColor = this.colorToHex(gridColor);
      this.canvasBuildingColor = this.colorToHex(buildingColor);
      this.canvasBuildingSelectedColor = this.colorToHex(buildingSelectedColor);
      this.canvasBuildingBorderColor = this.colorToHex(buildingBorderColor);
      this.canvasTextColor = this.colorToHex(textColor);
      this.canvasAccentColor = this.colorToHex(accentColor);

      console.info('Canvas colors loaded:', {
        background: this.canvasBackgroundColor,
        grid: this.canvasGridColor,
        building: this.canvasBuildingColor,
        text: this.canvasTextColor,
        accent: this.canvasAccentColor
      });
    } catch (error) {
      console.error('Failed to load canvas colors:', error);
    }
  }

  /**
   * å°†é¢œè‰²æ•°å€¼è½¬æ¢ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²
   */
  private colorToHex(color: number): string {
    // é¢œè‰²æ ¼å¼ä¸º ARGBï¼Œè½¬æ¢ä¸º #RRGGBB æˆ– #AARRGGBB
    const hex = (color >>> 0).toString(16).padStart(8, '0');
    return `#${hex.substring(2)}`; // å»æ‰alphaé€šé“ï¼Œåªä¿ç•™RGB
  }
  
  /**
   * ä¸»é¢˜å˜åŒ–æ—¶é‡æ–°åŠ è½½é¢œè‰²å¹¶é‡ç»˜
   */
  private async onThemeChange() {
    await this.loadCanvasColors();
    // å»¶è¿Ÿé‡ç»˜ï¼Œç¡®ä¿é¢œè‰²å·²æ›´æ–°
    setTimeout(() => {
      this.redraw();
    }, 50);
  }
  
  /**
   * æ˜¾ç¤ºåŸå¸‚é€‰æ‹©å¯¹è¯æ¡†
   */
  private showCityPickerDialog() {
    this.cityDialogController = new CustomDialogController({
      builder: CityPickerDialog({
        cities: this.cities,
        onSelect: (city: CityModel) => {
          this.selectCity(city);
        }
      }),
      autoCancel: true,
      alignment: DialogAlignment.Center,
      customStyle: true,
      maskColor: 'rgba(0, 0, 0, 0.5)'
    });
    this.cityDialogController.open();
  }

  /**
   * é€‰æ‹©åŸå¸‚
   */
  private selectCity(city: CityModel) {
    // æ›´æ–°é€‰ä¸­çš„åŸå¸‚åç§°
    this.selectedCity = city.getDisplayName();
    
    // æ›´æ–°ç»çº¬åº¦
    this.longitude = city.getLongitudeDecimal();
    this.latitude = city.getLatitudeDecimal();
    
    console.info(`é€‰æ‹©åŸå¸‚: ${city.getDisplayName()}, ç»åº¦: ${this.longitude}, çº¬åº¦: ${this.latitude}`);
  }
  
  /**
   * æ˜¾ç¤ºå†å²è®°å½•å¯¹è¯æ¡†
   */
  private showHistoryDialog() {
    if (!this.historyDialogController) {
      this.historyDialogController = new CustomDialogController({
        builder: AdvancedHistoryDialog({
          onLoad: (item: AdvancedHistoryItem) => {
            this.loadHistoryItem(item);
            this.historyDialogController?.close();
          },
          onClose: () => {
            this.historyDialogController?.close();
          }
        }),
        autoCancel: true,
        alignment: DialogAlignment.Center,
        customStyle: true
      });
    }
    this.historyDialogController.open();
  }

  /**
   * æ˜¾ç¤ºä¿å­˜å†å²è®°å½•å¯¹è¯æ¡†
   */
  private showSaveHistoryDialog() {
    if (!this.saveHistoryDialogController) {
      this.saveHistoryDialogController = new CustomDialogController({
        builder: SaveHistoryDialog({
          onSave: (name: string) => {
            this.saveHistory(name);
            this.saveHistoryDialogController?.close();
          },
          onClose: () => {
            this.saveHistoryDialogController?.close();
          }
        }),
        autoCancel: true,
        alignment: DialogAlignment.Center,
        customStyle: true
      });
    }
    this.saveHistoryDialogController.open();
  }

  /**
   * ä»å†å²è®°å½•åŠ è½½åœºæ™¯
   */
  private loadHistoryItem(item: AdvancedHistoryItem) {
    try {
      // æ¢å¤ç»çº¬åº¦å’Œæ¯”ä¾‹å°º
      this.latitude = item.latitude;
      this.longitude = item.longitude;
      this.scaleMetersPerCell = item.scaleMetersPerCell;
      
      // æ¢å¤åŸå¸‚åç§°
      const matchedCity = this.cities.find(city => city.getDisplayName() === item.cityName);
      if (matchedCity) {
        this.selectedCity = item.cityName;
      }
      
      // æ¢å¤å»ºç­‘ç‰©
      this.buildings = item.buildings.map((buildingJSON: BuildingJSON): BuildingModel => {
        const building = new BuildingModel();
        building.id = buildingJSON.id;
        building.width = buildingJSON.width;
        building.length = buildingJSON.length;
        building.height = buildingJSON.height;
        building.floorHeight = buildingJSON.floorHeight;
        building.units = buildingJSON.units;
        building.rotationDeg = buildingJSON.rotationDeg;
        building.x = buildingJSON.x;
        building.y = buildingJSON.y;
        return building;
      });
      
      // æ›´æ–° nextBuildingId
      if (this.buildings.length > 0) {
        const maxId = Math.max(...this.buildings.map(b => b.id));
        this.nextBuildingId = maxId + 1;
      } else {
        this.nextBuildingId = 1;
      }
      
      // é‡ç»˜ç”»å¸ƒ
      this.redraw();
      
      // å¦‚æœæœ‰è®¡ç®—ç»“æœ,æ¢å¤è®¡ç®—ç›®æ ‡
      if (item.hasResult && item.targetBuildingId !== undefined) {
        this.targetBuildingId = item.targetBuildingId;
        this.targetFloor = item.targetFloor || 1;
        this.targetUnit = item.targetUnit || 1;
        
        // å¯ä»¥é€‰æ‹©è‡ªåŠ¨é‡æ–°è®¡ç®—,æˆ–æ˜¾ç¤ºæç¤º
        promptAction.showToast({
          message: 'åœºæ™¯å·²åŠ è½½,å¯é‡æ–°è®¡ç®—æŸ¥çœ‹ç»“æœ',
          duration: 2000
        });
      } else {
        promptAction.showToast({
          message: 'åœºæ™¯åŠ è½½æˆåŠŸ',
          duration: 1500
        });
      }
      
      console.info('å†å²è®°å½•åŠ è½½æˆåŠŸ:', item.name);
    } catch (error) {
      console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
      promptAction.showToast({
        message: 'åŠ è½½å¤±è´¥,è¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  /**
   * ä¿å­˜å½“å‰åœºæ™¯åˆ°å†å²è®°å½•
   */
  private async saveHistory(name: string) {
    try {
      // åºåˆ—åŒ–å»ºç­‘ç‰©
      const buildingsJSON: BuildingJSON[] = this.buildings.map((building): BuildingJSON => {
        return {
          id: building.id,
          width: building.width,
          length: building.length,
          height: building.height,
          floorHeight: building.floorHeight,
          units: building.units,
          rotationDeg: building.rotationDeg,
          x: building.x,
          y: building.y
        };
      });
      
      // åˆ›å»ºå†å²è®°å½•é¡¹
      const historyItem: AdvancedHistoryItem = {
        id: Date.now().toString(),
        timestamp: Date.now(),
        name: name,
        cityName: this.selectedCity,
        latitude: this.latitude,
        longitude: this.longitude,
        scaleMetersPerCell: this.scaleMetersPerCell,
        buildingCount: this.buildings.length,
        buildings: buildingsJSON
      };
      
      // å¦‚æœæœ‰è®¡ç®—ç»“æœ,ä¸€å¹¶ä¿å­˜
      if (this.showResult && this.calculationResult && this.ratingResult) {
        historyItem.hasResult = true;
        historyItem.targetBuildingId = this.targetBuildingId;
        historyItem.targetFloor = this.targetFloor;
        historyItem.targetUnit = this.targetUnit;
        historyItem.totalSunshine = this.calculationResult.annualAverage;
        historyItem.winterSolsticeSunshine = this.calculationResult.winterSolstice;
        historyItem.greatColdSunshine = this.calculationResult.greatCold;
        historyItem.score = this.ratingResult.score;
      }
      
      // è·å– context
      const context = this.getUIContext()?.getHostContext();
      if (!context) {
        throw new Error('æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡');
      }
      
      // ä¿å­˜åˆ° HistoryManager
      await HistoryManager.saveAdvancedHistory(context, historyItem);
      
      promptAction.showToast({
        message: 'ä¿å­˜æˆåŠŸ',
        duration: 1500
      });
      
      console.info('å†å²è®°å½•ä¿å­˜æˆåŠŸ:', name);
    } catch (error) {
      console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', error);
      promptAction.showToast({
        message: 'ä¿å­˜å¤±è´¥,è¯·é‡è¯•',
        duration: 2000
      });
    }
  }
  
  /**
   * æ£€æµ‹å±å¹•å°ºå¯¸
   */
  private checkScreenSize() {
    // é»˜è®¤ä¸ºå¤§å±,ä¼šåœ¨é¦–æ¬¡ onAreaChange æ—¶æ›´æ–°
    this.isSmallScreen = false;
  }
  
  /**
   * æ›´æ–°å±å¹•å°ºå¯¸åˆ¤æ–­
   */
  private updateScreenSize(width: number) {

    if(this.alreadySetTheStatus) {
      return;
    }

    // æ ¹æ®å®é™…å®½åº¦åˆ¤æ–­æ˜¯å¦ä¸ºå°å±å¹•
    const wasSmallScreen = this.isSmallScreen;
    this.isSmallScreen = width < 600;
    
    // å¦‚æœå±å¹•ç±»å‹æ”¹å˜äº†,é‡ç»˜
    if (wasSmallScreen !== this.isSmallScreen) {
      this.alreadySetTheStatus = true;
      setTimeout(() => {
        this.redraw();
      }, 100);
    }
  }
  
  aboutToDisappear() {
    // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
    this.saveToStorage();
  }

  build() {
    Stack() {
      Column() {
        // æ ‡é¢˜æ 
        Row() {
          Button() {
            Text('â†')
              .fontSize(24)
              .fontColor(Color.White)
          }
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.getUIContext().getRouter().back();
          })
          .margin({ left: 8 })

          Text('é«˜çº§æ—¥ç…§è¯„ä¼°å™¨')
            .fontSize(this.isSmallScreen ? 18 : 20)
            .fontWeight(FontWeight.Medium)
            .fontColor(Color.White)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
            .margin({ right: 48 })
          
          // å†å²è®°å½•æŒ‰é’®
          Button() {
            Text('ğŸ“‹')
              .fontSize(20)
              .fontColor(Color.White)
          }
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.showHistoryDialog();
          })
          .margin({ right: 8 })
          
          // å°å±å¹•æ—¶æ˜¾ç¤ºåˆ‡æ¢æŒ‰é’®
          if (this.isSmallScreen) {
            Button(this.showControlPanel ? 'ç”»å¸ƒ' : 'è®¾ç½®')
              .fontSize(14)
              .height(35)
              .backgroundColor(Color.Transparent)
              .fontColor(Color.White)
              .onClick(() => {
                this.showControlPanel = !this.showControlPanel;
              })
              .margin({ right: 8 })
          }
        }
        .width('100%')
        .height(56)
        .backgroundColor('#1976D2')
        .padding({ left: 8, right: 8 })
        .alignItems(VerticalAlign.Center)

      if (this.isSmallScreen) {
        // å°å±å¹•:ä¸Šä¸‹å¸ƒå±€
        Column() {
          if (this.showControlPanel) {
            // æ§åˆ¶é¢æ¿
            Scroll() {
              Column() {
                this.buildBasicSettings()
                this.buildBuildingEditor()
                this.buildBuildingList()
                this.buildCalculationPanel()
                this.buildUnitAnalysisPanel()
              }
              .width('100%')
            }
            .width('100%')
            .layoutWeight(1)
            .backgroundColor($r('app.color.page_background'))
          } else {
            // ç»˜å›¾åŒºåŸŸ
            Column() {
              // å·¥å…·æ 
              Row() {
                Text('ç»˜å›¾åŒºåŸŸ')
                  .fontSize(14)
                  .layoutWeight(1)

                if (this.isPlacingBuilding) {
                  Button('å–æ¶ˆæ”¾ç½®')
                    .fontSize(12)
                    .height(30)
                    .backgroundColor('#F44336')
                    .margin({ right: 5 })
                    .onClick(() => {
                      this.isPlacingBuilding = false;
                      this.showPreview = false;
                      this.redraw();
                    })
                  
                  Button('ç¡®è®¤æ”¾ç½®')
                    .fontSize(12)
                    .height(30)
                    .backgroundColor('#4CAF50')
                    .margin({ right: 5 })
                    .onClick(() => {
                      if (this.showPreview) {
                        this.placeBuilding(
                          this.canvasWidth / 2 + this.previewX * 40,
                          this.canvasHeight / 2 + this.previewY * 40
                        );
                      }
                    })
                }

                // 3DåŠŸèƒ½å·²éšè—
                // Button(this.viewMode === '2d' ? '2D' : '3D')
                //   .fontSize(12)
                //   .height(30)
                //   .onClick(() => {
                //     this.viewMode = this.viewMode === '2d' ? '3d' : '2d';
                //     this.redraw();
                //   })
              }
              .width('100%')
              .padding(10)
              .backgroundColor($r('app.color.card_background'))

              // Canvasç”»å¸ƒ
              Canvas(this.canvasContext)
                .width('100%')
                .layoutWeight(1)
                .backgroundColor($r('app.color.card_background'))
                .onAreaChange((oldArea, newArea) => {
                  // è·å–å®é™…ç”»å¸ƒå¤§å°
                  const newWidth = newArea.width as number;
                  const newHeight = newArea.height as number;
                  
                  // æ£€æµ‹å°ºå¯¸æ˜¯å¦çœŸçš„å˜åŒ–äº†
                  const sizeChanged = (Math.abs(newWidth - this.canvasWidth) > 1 || Math.abs(newHeight - this.canvasHeight) > 1);
                  
                  this.canvasWidth = newWidth;
                  this.canvasHeight = newHeight;
                  
                  // é¦–æ¬¡åŠ è½½æ—¶åˆ¤æ–­å±å¹•å°ºå¯¸
                  if (oldArea.width === 0) {
                    this.updateScreenSize(this.canvasWidth);
                  }
                  
                  // å¦‚æœå°ºå¯¸å˜åŒ–äº†,é‡ç»˜
                  if (sizeChanged && oldArea.width > 0) {
                    setTimeout(() => {
                      this.redraw();
                    }, 50);
                  }
                })
                .onReady(() => {
                  this.initCanvas();
                })
                .onTouch((event) => {
                  this.handleCanvasTouch(event);
                })
                .onMouse((event) => {
                  this.handleCanvasMouse(event);
                })
            }
            .width('100%')
            .layoutWeight(1)
          }
        }
        .layoutWeight(1)
      } else {
        // å¤§å±å¹•:å·¦å³å¸ƒå±€
        Row() {
          // å·¦ä¾§æ§åˆ¶é¢æ¿
          Column() {
            Scroll() {
              Column() {
                this.buildBasicSettings()
                this.buildBuildingEditor()
                this.buildBuildingList()
                this.buildCalculationPanel()
                this.buildUnitAnalysisPanel()
              }
              .width('100%')
            }
            .layoutWeight(1)
          }
          .width('30%')
          .height('100%')
          .backgroundColor($r('app.color.page_background'))

          // å³ä¾§ç»˜å›¾åŒºåŸŸ
          Column() {
            // å·¥å…·æ 
            Row() {
              Text('ç»˜å›¾åŒºåŸŸ (ä¸ŠåŒ—ä¸‹å—)')
                .fontSize(16)
                .layoutWeight(1)

              // 3DåŠŸèƒ½å·²éšè—
              // Button(this.viewMode === '2d' ? '2D' : '3D')
              //   .fontSize(14)
              //   .height(30)
              //   .margin({ left: 10 })
              //   .onClick(() => {
              //     this.viewMode = this.viewMode === '2d' ? '3d' : '2d';
              //     this.redraw();
              //   })
            }
            .width('100%')
            .padding(10)
            .backgroundColor($r('app.color.card_background'))

            // Canvasç”»å¸ƒ
            Canvas(this.canvasContext)
              .width('100%')
              .layoutWeight(1)
              .backgroundColor($r('app.color.card_background'))
              .onAreaChange((oldArea, newArea) => {
                // è·å–å®é™…ç”»å¸ƒå¤§å°
                this.canvasWidth = newArea.width as number;
                this.canvasHeight = newArea.height as number;
                // é¦–æ¬¡åŠ è½½æ—¶åˆ¤æ–­å±å¹•å°ºå¯¸
                if (oldArea.width === 0) {
                  this.updateScreenSize(this.canvasWidth);
                }
              })
              .onReady(() => {
                this.initCanvas();
              })
              .onTouch((event) => {
                this.handleCanvasTouch(event);
              })
              .onMouse((event) => {
                this.handleCanvasMouse(event);
              })
          }
          .width('70%')
          .height('100%')
        }
        .layoutWeight(1)
      }
      }
      .width('100%')
      .height('100%')

      // åŠ è½½é®ç½©å±‚
      if (this.calculating) {
        this.buildLoadingMask()
      }

      // å•å…ƒè§†å›¾å¼¹çª—
      if (this.showUnitView) {
        this.buildUnitViewDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * åŠ è½½é®ç½©å±‚
   */
  @Builder
  buildLoadingMask() {
    Column() {
      Column() {
        LoadingProgress()
          .width(80)
          .height(80)
          .color($r('sys.color.ohos_id_color_emphasize'))
          .margin({ bottom: 20 })
        
        Text(this.calculationProgress || 'æ­£åœ¨è®¡ç®—æ—¥ç…§æ—¶é—´...')
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
          .margin({ bottom: 10 })
        
        if (this.totalUnitsToCalculate > 0) {
          Text(`å·²è®¡ç®— ${this.calculatedUnits}/${this.totalUnitsToCalculate} ä¸ªå•å…ƒ`)
            .fontSize(14)
            .fontColor($r('sys.color.ohos_id_color_emphasize'))
            .margin({ bottom: 5 })
          
          Progress({ value: this.calculatedUnits, total: this.totalUnitsToCalculate, type: ProgressType.Linear })
            .width(200)
            .height(4)
            .color($r('sys.color.ohos_id_color_emphasize'))
            .margin({ bottom: 10 })
        }
        
        Text('è€ƒè™‘å¤šå»ºç­‘ç‰©é®æŒ¡')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .margin({ bottom: 5 })
        
        Text('è¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
      }
      .width(300)
      .padding(30)
      .backgroundColor($r('app.color.card_background'))
      .borderRadius(16)
      .shadow({
        radius: 20,
        color: 'rgba(0, 0, 0, 0.15)',
        offsetX: 0,
        offsetY: 4
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('rgba(0, 0, 0, 0.5)')
    .justifyContent(FlexAlign.Center)
  }

  /**
   * å•å…ƒè§†å›¾å¼¹çª—
   */
  @Builder
  buildUnitViewDialog() {
    Column() {
      Column() {
        // æ ‡é¢˜æ 
        Row() {
          Text(this.activeUnitView === 'table' ? 'å•å…ƒæ—¥ç…§è¡¨' : '3Dçƒ­åŠ›å›¾')
            .fontSize(20)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)

          Button('å…³é—­')
            .fontSize(14)
            .height(35)
            .backgroundColor('#F44336')
            .onClick(() => {
              this.showUnitView = false;
            })
        }
        .width('100%')
        .padding(15)
        .backgroundColor($r('sys.color.ohos_id_color_emphasize'))
        .margin({ bottom: 10 })

        // å†…å®¹åŒºåŸŸ
        if (this.activeUnitView === 'table') {
          UnitSunshineTable({ sunshineData: $unitSunshineData })
        } else {
          Building3DView({ 
            buildings: $buildings,
            sunshineData: $unitSunshineData
          })
        }
      }
      .width(this.isSmallScreen ? '95%' : '90%')
      .height(this.isSmallScreen ? '90%' : '85%')
      .backgroundColor($r('app.color.card_background'))
      .borderRadius(16)
      .shadow({
        radius: 20,
        color: 'rgba(0, 0, 0, 0.2)',
        offsetX: 0,
        offsetY: 4
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('rgba(0, 0, 0, 0.6)')
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  buildBasicSettings() {
    Column() {
      Text('åŸºæœ¬è®¾ç½®')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 10 })

      // åŸå¸‚é€‰æ‹©
      Row() {
        Text('é€‰æ‹©åŸå¸‚')
          .fontSize(14)
          .width('40%')
        
        Button(this.selectedCity)
          .fontSize(14)
          .width('60%')
          .onClick(() => {
            this.showCityPickerDialog();
          })
      }
      .width('100%')
      .margin({ bottom: 8 })

      this.buildInputItem('ç»åº¦', this.longitude.toString(), (value: string) => {
        const num = parseFloat(value);
        if (!isNaN(num)) {
          this.longitude = num;
        }
      })

      this.buildInputItem('çº¬åº¦', this.latitude.toString(), (value: string) => {
        const num = parseFloat(value);
        if (!isNaN(num)) {
          this.latitude = num;
        }
      })

      // æ¯”ä¾‹å°ºå›ºå®šä¸º10ç±³,åªè¯»æ˜¾ç¤º
      Row() {
        Text('æ¯”ä¾‹å°º(ç±³/æ ¼)')
          .fontSize(14)
          .width('40%')
        
        Text('10 (å›ºå®š)')
          .fontSize(14)
          .width('60%')
          .fontColor($r('app.color.text_secondary'))
      }
      .width('100%')
      .margin({ bottom: 8 })
      
      // æ•°æ®ç®¡ç†æŒ‰é’®
      Row() {
        Button('å¯¼å‡º')
          .fontSize(14)
          .width('30%')
          .onClick(() => {
            this.exportData();
          })
        
        Button('å¯¼å…¥')
          .fontSize(14)
          .width('30%')
          .onClick(() => {
            this.importData();
          })
        
        Button('æ¸…ç©º')
          .fontSize(14)
          .width('30%')
          .backgroundColor('#F44336')
          .onClick(() => {
            this.clearAllBuildings();
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ top: 10 })
    }
    .width('100%')
    .padding(15)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(10)
    .margin({ bottom: 10 })
  }

  @Builder
  buildBuildingEditor() {
    Column() {
      Text('å»ºç­‘ç‰©ç¼–è¾‘')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 10 })

      // å»ºç­‘ç‰©å‚æ•°è¾“å…¥
      this.buildInputItem('å®½åº¦(ç±³)', this.pendingWidth.toString(), (value: string) => {
        const num = parseFloat(value);
        if (!isNaN(num) && num > 0) {
          this.pendingWidth = num;
          if (this.selectedBuildingId !== null) {
            this.updateSelectedBuilding();
          }
        }
      })

      this.buildInputItem('é•¿åº¦(ç±³)', this.pendingLength.toString(), (value: string) => {
        const num = parseFloat(value);
        if (!isNaN(num) && num > 0) {
          this.pendingLength = num;
          if (this.selectedBuildingId !== null) {
            this.updateSelectedBuilding();
          }
        }
      })

      this.buildInputItem('æ€»é«˜åº¦(ç±³)', this.pendingHeight.toString(), (value: string) => {
        const num = parseFloat(value);
        if (!isNaN(num) && num > 0) {
          this.pendingHeight = num;
          if (this.selectedBuildingId !== null) {
            this.updateSelectedBuilding();
          }
        }
      })

      this.buildInputItem('å±‚é«˜(ç±³)', this.pendingFloorHeight.toString(), (value: string) => {
        const num = parseFloat(value);
        if (!isNaN(num) && num > 0) {
          this.pendingFloorHeight = num;
          if (this.selectedBuildingId !== null) {
            this.updateSelectedBuilding();
          }
        }
      })

      this.buildInputItem('å•å…ƒæ•°', this.pendingUnits.toString(), (value: string) => {
        const num = parseInt(value);
        if (!isNaN(num) && num > 0) {
          this.pendingUnits = num;
          if (this.selectedBuildingId !== null) {
            this.updateSelectedBuilding();
          }
        }
      })

      this.buildInputItem('æ—‹è½¬è§’åº¦(Â°)', this.pendingRotation.toString(), (value: string) => {
        const num = parseFloat(value);
        if (!isNaN(num)) {
          this.pendingRotation = num;
          if (this.selectedBuildingId !== null) {
            this.updateSelectedBuilding();
          }
        }
      })

      Text(this.isPlacingBuilding ? 
        (this.isSmallScreen ? 'åˆ‡æ¢åˆ°ç”»å¸ƒæ ‡ç­¾é¡µæ”¾ç½®å»ºç­‘' : 'ç°åœ¨ç‚¹å‡»ç”»å¸ƒæ”¾ç½®å»ºç­‘ç‰©') : 
        'è°ƒæ•´å‚æ•°åç‚¹å‡»"å¼€å§‹æ”¾ç½®"')
        .fontSize(12)
        .fontColor(this.isPlacingBuilding ? '#FF6B00' : $r('app.color.text_secondary'))
        .margin({ top: 10, bottom: 10 })

      Row() {
        Button(this.isPlacingBuilding ? 'å–æ¶ˆæ”¾ç½®' : 'å¼€å§‹æ”¾ç½®')
          .fontSize(this.isSmallScreen ? 16 : 14)
          .height(this.isSmallScreen ? 44 : 36)
          .layoutWeight(1)
          .backgroundColor(this.isPlacingBuilding ? '#FF5722' : $r('sys.color.ohos_id_color_emphasize'))
          .onClick(() => {
            this.startPlacingBuilding();
          })

        if (this.selectedBuildingId !== null) {
          Button('åˆ é™¤æ‰€é€‰')
            .fontSize(this.isSmallScreen ? 16 : 14)
            .height(this.isSmallScreen ? 44 : 36)
            .layoutWeight(1)
            .margin({ left: 8 })
            .backgroundColor('#F44336')
            .onClick(() => {
              this.deleteSelectedBuilding();
            })
        }
      }
      .width('100%')

      Text(this.isSmallScreen ? 'ç‚¹å‡»åˆ—è¡¨é€‰æ‹©; ç”»å¸ƒå¯æ‹–åŠ¨' : 'ç‚¹å‡»åˆ—è¡¨æˆ–ç”»å¸ƒé€‰æ‹©æ¥¼æ ‹; æ‹–åŠ¨ç§»åŠ¨')
        .fontSize(11)
        .fontColor($r('app.color.text_secondary'))
        .margin({ top: 8 })
    }
    .width('100%')
    .padding(15)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(10)
    .margin({ bottom: 10 })
  }

  @Builder
  buildBuildingList() {
    Column() {
      Text('å»ºç­‘ç‰©åˆ—è¡¨')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 10 })

      if (this.buildings.length === 0) {
        Text('æš‚æ— å»ºç­‘ç‰©')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .margin({ top: 10 })
      } else {
        ForEach(this.buildings, (building: BuildingModel) => {
          this.buildBuildingListItem(building)
        })
      }
    }
    .width('100%')
    .padding(15)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(10)
    .margin({ bottom: 10 })
  }

  @Builder
  buildBuildingListItem(building: BuildingModel) {
    Column() {
      Text(`#${building.id}`)
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 4 })
      
      Text(`W:${(building.width * this.scaleMetersPerCell).toFixed(1)}m L:${(building.length * this.scaleMetersPerCell).toFixed(1)}m H:${building.height}m`)
        .fontSize(11)
        .fontColor($r('app.color.text_secondary'))
      
      Text(`å±‚:${Math.floor(building.height / building.floorHeight)} å•å…ƒ:${building.units}`)
        .fontSize(11)
        .fontColor($r('app.color.text_secondary'))
    }
    .alignItems(HorizontalAlign.Start)
    .width('100%')
    .padding(10)
    .backgroundColor(this.selectedBuildingId === building.id ? $r('app.color.success_background') : $r('app.color.input_background'))
    .borderRadius(5)
    .margin({ bottom: 5 })
    .border({
      width: this.selectedBuildingId === building.id ? 2 : 0,
      color: $r('sys.color.ohos_id_color_emphasize')
    })
    .onClick(() => {
      this.selectBuilding(building.id);
    })
  }

  @Builder
  buildCalculationPanel() {
    Column() {
      Text('æ—¥ç…§è®¡ç®—')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 10 })

      // é€‰æ‹©ç›®æ ‡å»ºç­‘
      Row() {
        Text('ç›®æ ‡å»ºç­‘')
          .fontSize(14)
          .width('40%')

        if (this.targetBuildingOptions.length > 0) {
          Select(this.targetBuildingOptions.map((id: string): SelectOption => {
            return { value: id } as SelectOption;
          }))
            .width('60%')
            .value(`#${this.targetBuildingId}`)
            .onSelect((index: number) => {
              const value = this.targetBuildingOptions[index];
              const num = parseInt(value.replace('#', ''));
              if (!isNaN(num)) {
                this.targetBuildingId = num;
                this.updateTargetFloorOptions();
              }
            })
        } else {
          Text('æ— å»ºç­‘ç‰©')
            .fontSize(14)
            .width('60%')
            .fontColor($r('app.color.text_secondary'))
        }
      }
      .width('100%')
      .margin({ bottom: 8 })

      // é€‰æ‹©æ¥¼å±‚
      Row() {
        Text('æ¥¼å±‚')
          .fontSize(14)
          .width('40%')

        if (this.targetFloorOptions.length > 0) {
          Select(this.targetFloorOptions.map((floor: string): SelectOption => {
            return { value: floor } as SelectOption;
          }))
            .width('60%')
            .value(this.targetFloor.toString())
            .onSelect((index: number) => {
              const value = this.targetFloorOptions[index];
              const num = parseInt(value);
              if (!isNaN(num)) {
                this.targetFloor = num;
              }
            })
        } else {
          Text('-')
            .fontSize(14)
            .width('60%')
            .fontColor($r('app.color.text_secondary'))
        }
      }
      .width('100%')
      .margin({ bottom: 8 })

      // é€‰æ‹©å•å…ƒ
      Row() {
        Text('å•å…ƒ(å³èµ·)')
          .fontSize(14)
          .width('40%')

        if (this.targetUnitOptions.length > 0) {
          Select(this.targetUnitOptions.map((unit: string): SelectOption => {
            return { value: unit } as SelectOption;
          }))
            .width('60%')
            .value(this.targetUnit.toString())
            .onSelect((index: number) => {
              const value = this.targetUnitOptions[index];
              const num = parseInt(value);
              if (!isNaN(num)) {
                this.targetUnit = num;
              }
            })
        } else {
          Text('-')
            .fontSize(14)
            .width('60%')
            .fontColor($r('app.color.text_secondary'))
        }
      }
      .width('100%')
      .margin({ bottom: 15 })

      Button('è®¡ç®—æ—¥ç…§')
        .width('100%')
        .enabled(!this.calculating)
        .onClick(() => {
          this.calculateSunshine();
        })

      if (this.showResult && this.calculationResult) {
        this.buildResultDisplay()
      }
    }
    .width('100%')
    .padding(15)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(10)
    .margin({ bottom: 10 })
  }

  @Builder
  buildResultDisplay() {
    Column() {
      Text('è®¡ç®—ç»“æœ')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .margin({ top: 15, bottom: 10 })

      // è¯„åˆ†å¡ç‰‡
      if (this.ratingResult) {
        SunshineRatingCard({ ratingResult: this.ratingResult })
          .margin({ bottom: 15 })
      }

      if (this.calculationResult) {
        Column() {
          this.buildResultRow('å»ºç­‘ID', `#${this.calculationResult.buildingId}`)
          this.buildResultRow('æ¥¼å±‚', `${this.calculationResult.floorIndex}å±‚`)
          this.buildResultRow('å•å…ƒ', `${this.calculationResult.unitIndex}å·(å³èµ·)`)
          
          Divider().margin({ top: 10, bottom: 10 })
          
          this.buildResultRow('æ˜¥åˆ†æ—¥ç…§', `${this.calculationResult.springEquinox.toFixed(2)}å°æ—¶`)
          this.buildResultRow('å¤è‡³æ—¥ç…§', `${this.calculationResult.summerSolstice.toFixed(2)}å°æ—¶`)
          this.buildResultRow('ç§‹åˆ†æ—¥ç…§', `${this.calculationResult.autumnalEquinox.toFixed(2)}å°æ—¶`)
          this.buildResultRow('å†¬è‡³æ—¥ç…§', `${this.calculationResult.winterSolstice.toFixed(2)}å°æ—¶`)
          this.buildResultRow('å¤§å¯’æ—¥ç…§', `${this.calculationResult.greatCold.toFixed(2)}å°æ—¶`)
          
          Divider().margin({ top: 10, bottom: 10 })
          
          Row() {
            Text('å¹´å‡æ—¥ç…§')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .width('50%')
            
            Text(`${this.calculationResult.annualAverage.toFixed(2)}å°æ—¶/å¤©`)
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF6B00')
              .width('50%')
              .textAlign(TextAlign.End)
          }
          .width('100%')
          .margin({ bottom: 5 })
        }
        .width('100%')
        .padding(10)
        .backgroundColor($r('app.color.input_background'))
        .borderRadius(8)
        
        // æ—¥ç…§æ—¶é—´å¯è§†åŒ–å›¾è¡¨
        SunshineCharts({ calculationResult: this.calculationResult })
          .margin({ top: 15 })
      }
      
      // ä¿å­˜åˆ°å†å²è®°å½•æŒ‰é’®
      Button('ä¿å­˜åœºæ™¯')
        .width('100%')
        .height(40)
        .margin({ top: 15 })
        .backgroundColor('#4CAF50')
        .onClick(() => {
          this.showSaveHistoryDialog();
        })
    }
    .width('100%')
  }

  @Builder
  buildResultRow(label: string, value: string) {
    Row() {
      Text(label)
        .fontSize(14)
        .width('50%')

      Text(value)
        .fontSize(14)
        .width('50%')
        .textAlign(TextAlign.End)
    }
    .width('100%')
    .margin({ bottom: 5 })
  }

  /**
   * å»ºç­‘å•å…ƒåˆ†æé¢æ¿
   */
  @Builder
  buildUnitAnalysisPanel() {
    Column() {
      Text('å»ºç­‘å•å…ƒåˆ†æ')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 10 })

      Text('åˆ†ææŒ‡å®šå»ºç­‘æ‰€æœ‰å•å…ƒçš„æ—¥ç…§æƒ…å†µ,ä»¥3Dçƒ­åŠ›å›¾æˆ–è¡¨æ ¼å½¢å¼å±•ç¤º')
        .fontSize(12)
        .fontColor($r('app.color.text_secondary'))
        .margin({ bottom: 15 })

      // é€‰æ‹©ç›®æ ‡å»ºç­‘
      Row() {
        Text('ç›®æ ‡å»ºç­‘')
          .fontSize(14)
          .width('40%')

        if (this.targetBuildingOptions.length > 0) {
          Select(this.targetBuildingOptions.map((id: string): SelectOption => {
            return { value: id } as SelectOption;
          }))
            .width('60%')
            .value(`#${this.targetBuildingId}`)
            .onSelect((index: number) => {
              const value = this.targetBuildingOptions[index];
              const num = parseInt(value.replace('#', ''));
              if (!isNaN(num)) {
                this.targetBuildingId = num;
              }
            })
        } else {
          Text('æ— å»ºç­‘ç‰©')
            .fontSize(14)
            .width('60%')
            .fontColor($r('app.color.text_secondary'))
        }
      }
      .width('100%')
      .margin({ bottom: 15 })

      Button('åˆ†ææ‰€æœ‰å•å…ƒ')
        .width('100%')
        .enabled(!this.calculating && this.buildings.length > 0)
        .onClick(() => {
          this.calculateAllUnits();
        })

      if (this.showUnitView && this.unitSunshineData.length > 0) {
        // è§†å›¾åˆ‡æ¢æŒ‰é’®
        Row() {
          Button('è¡¨æ ¼è§†å›¾')
            .fontSize(14)
            .height(35)
            .layoutWeight(1)
            .backgroundColor(this.activeUnitView === 'table' ? '#1976D2' : '#E0E0E0')
            .fontColor(this.activeUnitView === 'table' ? Color.White : '#333333')
            .margin({ right: 5 })
            .onClick(() => {
              this.activeUnitView = 'table';
            })

          Button('3Dçƒ­åŠ›å›¾')
            .fontSize(14)
            .height(35)
            .layoutWeight(1)
            .backgroundColor(this.activeUnitView === '3d' ? '#1976D2' : '#E0E0E0')
            .fontColor(this.activeUnitView === '3d' ? Color.White : '#333333')
            .margin({ left: 5 })
            .onClick(() => {
              this.activeUnitView = '3d';
            })
        }
        .width('100%')
        .margin({ top: 15 })
      }
    }
    .width('100%')
    .padding(15)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(10)
    .margin({ bottom: 10 })
  }

  @Builder
  buildInputItem(label: string, value: string, onChange: (value: string) => void) {
    Row() {
      Text(label)
        .fontSize(14)
        .width('40%')

      TextInput({ text: value })
        .fontSize(14)
        .width('60%')
        .onChange(onChange)
    }
    .width('100%')
    .margin({ bottom: 8 })
  }
  
  /**
   * åˆå§‹åŒ–Canvas
   */
  private async initCanvas() {
    // ç¡®ä¿é¢œè‰²å·²åŠ è½½
    await this.loadCanvasColors();
    // å»¶è¿Ÿä¸€ä¸‹å†ç»˜åˆ¶,ç¡®ä¿å°ºå¯¸å·²æ›´æ–°
    setTimeout(() => {
      this.redraw();
    }, 100);
  }

  /**
   * é‡ç»˜Canvas
   */
  private redraw() {
    if (!this.canvasContext) {
      return;
    }

    // æ¸…ç©ºç”»å¸ƒ
    this.canvasContext.clearRect(0, 0, this.canvasWidth, this.canvasHeight);
    
    // å¡«å……èƒŒæ™¯ - ä½¿ç”¨èµ„æºé¢œè‰²
    this.canvasContext.fillStyle = this.canvasBackgroundColor;
    this.canvasContext.fillRect(0, 0, this.canvasWidth, this.canvasHeight);

    if (this.viewMode === '2d') {
      this.draw2D();
    } else {
      this.draw3D();
    }
  }
  
  /**
   * èŠ‚æµé‡ç»˜ - ç”¨äºé¢‘ç¹è§¦å‘çš„åœºæ™¯(å¦‚é¼ æ ‡ç§»åŠ¨)
   */
  private redrawThrottled() {
    const now = Date.now();
    if (now - this.lastRedrawTime < this.REDRAW_THROTTLE_MS) {
      // è·³è¿‡æœ¬æ¬¡é‡ç»˜
      return;
    }
    this.lastRedrawTime = now;
    this.redraw();
  }

  /**
   * 2Dç»˜å›¾
   */
  private draw2D() {
    if (!this.canvasContext) {
      return;
    }

    const ctx = this.canvasContext;

    // ç»˜åˆ¶ç½‘æ ¼
    this.drawGrid(ctx);

    // ç»˜åˆ¶å»ºç­‘ç‰©
    this.buildings.forEach(building => {
      this.drawBuilding2D(ctx, building, false);
    });
    
    // ç»˜åˆ¶é¢„è§ˆå»ºç­‘ç‰©
    if (this.showPreview && this.isPlacingBuilding) {
      this.drawPreviewBuilding(ctx);
    }
  }

  /**
   * 3Dç»˜å›¾
   */
  private draw3D() {
    if (!this.canvasContext) {
      return;
    }

    const ctx = this.canvasContext;
    
    // æ¸…ç©ºç”»å¸ƒ
    ctx.clearRect(0, 0, this.canvasWidth, this.canvasHeight);
    
    // ç»˜åˆ¶èƒŒæ™¯æ¸å˜ - æ ¹æ®ä¸»é¢˜é€‰æ‹©é¢œè‰²
    const gradient = ctx.createLinearGradient(0, 0, 0, this.canvasHeight);
    if (this.isDarkMode) {
      gradient.addColorStop(0, '#1C1C1E');
      gradient.addColorStop(1, '#2C2C2E');
    } else {
      gradient.addColorStop(0, '#E3F2FD');
      gradient.addColorStop(1, '#BBDEFB');
    }
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, this.canvasWidth, this.canvasHeight);

    const centerX = this.canvasWidth / 2;
    const centerY = this.canvasHeight / 2;

    // ç»˜åˆ¶ç½‘æ ¼
    this.draw3DGrid(ctx, centerX, centerY);

    // ç»˜åˆ¶æ‰€æœ‰å»ºç­‘ç‰©
    for (const building of this.buildings) {
      this.drawBuilding3D(ctx, building, centerX, centerY, false);
    }

    // ç»˜åˆ¶é¢„è§ˆå»ºç­‘
    if (this.showPreview && this.isPlacingBuilding) {
      const previewBuilding = new BuildingModel();
      previewBuilding.x = this.previewX;
      previewBuilding.y = this.previewY;
      previewBuilding.width = this.pendingWidth / this.scaleMetersPerCell;
      previewBuilding.length = this.pendingLength / this.scaleMetersPerCell;
      previewBuilding.height = this.pendingHeight;
      previewBuilding.floorHeight = this.pendingFloorHeight;
      previewBuilding.units = this.pendingUnits;
      previewBuilding.rotationDeg = this.pendingRotation;
      this.drawBuilding3D(ctx, previewBuilding, centerX, centerY, true);
    }
  }

  /**
   * ç»˜åˆ¶3Dç½‘æ ¼
   */
  private draw3DGrid(ctx: CanvasRenderingContext2D, centerX: number, centerY: number) {
    // æ ¹æ®ä¸»é¢˜é€‰æ‹©ç½‘æ ¼é¢œè‰²
    ctx.strokeStyle = this.isDarkMode ? 'rgba(144, 202, 249, 0.15)' : 'rgba(144, 202, 249, 0.3)';
    ctx.lineWidth = 1;

    const gridSize = 80; // æ”¾å¤§ä¸€å€
    const gridCount = 15;
    const scale = 1.2; // æ”¾å¤§æ¯”ä¾‹

    // ç»˜åˆ¶åœ°é¢ç½‘æ ¼ï¼ˆç­‰è½´æµ‹æŠ•å½±ï¼‰
    for (let i = -gridCount; i <= gridCount; i++) {
      // Xæ–¹å‘çš„çº¿ï¼ˆå—åŒ—æ–¹å‘ï¼‰
      ctx.beginPath();
      for (let j = -gridCount; j <= gridCount; j++) {
        const x = centerX + (i * gridSize * scale) + (j * gridSize * scale * 0.5);
        const y = centerY + (j * gridSize * scale * 0.5) - (i * gridSize * scale * 0.25);
        
        if (j === -gridCount) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      }
      ctx.stroke();

      // Yæ–¹å‘çš„çº¿ï¼ˆä¸œè¥¿æ–¹å‘ï¼‰
      ctx.beginPath();
      for (let j = -gridCount; j <= gridCount; j++) {
        const x = centerX + (j * gridSize * scale) + (i * gridSize * scale * 0.5);
        const y = centerY + (i * gridSize * scale * 0.5) - (j * gridSize * scale * 0.25);
        
        if (j === -gridCount) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      }
      ctx.stroke();
    }

    // ç»˜åˆ¶ä¸­å¿ƒåå­—
    ctx.strokeStyle = '#FF6B00';
    ctx.lineWidth = 2;
    
    const crossSize = gridSize;
    // åŒ—æ–¹å‘
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.lineTo(centerX, centerY - crossSize);
    ctx.stroke();
    
    // å—æ–¹å‘
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.lineTo(centerX, centerY + crossSize * 0.5);
    ctx.stroke();

    // æ ‡æ³¨æ–¹ä½
    ctx.fillStyle = '#FF6B00';
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('åŒ—', centerX, centerY - crossSize - 15);
  }

  /**
   * ç»˜åˆ¶3Då»ºç­‘ç‰©
   */
  private drawBuilding3D(ctx: CanvasRenderingContext2D, building: BuildingModel, 
                         centerX: number, centerY: number, isPreview: boolean = false) {
    const gridSize = 80; // æ”¾å¤§ä¸€å€
    const scale = 1.2; // æ”¾å¤§æ¯”ä¾‹
    const heightScale = 3.5; // Zè½´ç¼©æ”¾,ä½¿å»ºç­‘é«˜åº¦æ›´æ˜æ˜¾

    // å»ºç­‘ç‰©æ—‹è½¬è§’åº¦
    const angle = building.rotationDeg * Math.PI / 180;
    const cosA = Math.cos(angle);
    const sinA = Math.sin(angle);

    // å»ºç­‘ç‰©æœ¬åœ°åæ ‡çš„4ä¸ªè§’ç‚¹ï¼ˆæ—‹è½¬å‰ï¼‰
    const halfW = building.width / 2;
    const halfL = building.length / 2;

    const localCorners: Point2D[] = [
      { x: -halfW, y: -halfL },  // å·¦å‰
      { x: halfW, y: -halfL },   // å³å‰
      { x: halfW, y: halfL },    // å³å
      { x: -halfW, y: halfL }    // å·¦å
    ];

    // æ—‹è½¬å¹¶è½¬æ¢åˆ°ä¸–ç•Œåæ ‡
    const bottom: Point3D[] = [];
    const top: Point3D[] = [];

    for (const corner of localCorners) {
      // æ—‹è½¬
      const worldX = building.x + corner.x * cosA - corner.y * sinA;
      const worldY = building.y + corner.x * sinA + corner.y * cosA;
      
      bottom.push({ x: worldX, y: worldY, z: 0 });
      top.push({ x: worldX, y: worldY, z: building.height });
    }

    // ç­‰è½´æµ‹æŠ•å½±åˆ°2D
    const project = (p: Point3D): Point2D => {
      // ç­‰è½´æµ‹æŠ•å½±ï¼šxå‘å³ï¼Œyå‘å³ä¸‹ï¼Œzå‘ä¸Š
      const screenX = centerX + (p.x * gridSize * scale) + (p.y * gridSize * scale * 0.5);
      const screenY = centerY + (p.y * gridSize * scale * 0.5) - (p.x * gridSize * scale * 0.25) - (p.z * heightScale);
      
      const result: Point2D = {
        x: screenX,
        y: screenY
      };
      return result;
    };

    const bottomProj = bottom.map(project);
    const topProj = top.map(project);

    // æ£€æŸ¥æ˜¯å¦æœ‰çƒ­åŠ›å›¾æ•°æ®
    const hasHeatmap = this.unitSunshineData.length > 0 && 
                       this.unitSunshineData.some(d => d.buildingId === building.id);

    // å¦‚æœæœ‰çƒ­åŠ›å›¾æ•°æ®,æŒ‰å•å…ƒç»˜åˆ¶
    if (hasHeatmap && !isPreview) {
      this.drawBuilding3DWithHeatmap(ctx, building, centerX, centerY, gridSize, scale, heightScale);
    } else {
      // æ­£å¸¸ç»˜åˆ¶
      // è®¾ç½®æ ·å¼
      if (isPreview) {
        ctx.fillStyle = 'rgba(33, 150, 243, 0.3)';
        ctx.strokeStyle = '#2196F3';
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
      } else {
        // æ ¹æ®æ˜¯å¦è¢«é€‰ä¸­å’Œä¸»é¢˜è®¾ç½®æ ·å¼
        if (building.id === this.selectedBuildingId) {
          ctx.fillStyle = 'rgba(255, 152, 0, 0.7)';
          ctx.strokeStyle = '#FF9800';
        } else {
          // æ·±è‰²æ¨¡å¼ä½¿ç”¨ç¨äº®çš„è“è‰²
          if (this.isDarkMode) {
            ctx.fillStyle = 'rgba(66, 165, 245, 0.7)';
          } else {
            ctx.fillStyle = 'rgba(25, 118, 210, 0.7)';
          }
          ctx.strokeStyle = '#1976D2';
        }
        ctx.lineWidth = 2;
        ctx.setLineDash([]);
      }

      // ç»˜åˆ¶å¯è§é¢
      // å‰é¢
      ctx.beginPath();
      ctx.moveTo(bottomProj[2].x, bottomProj[2].y);
      ctx.lineTo(topProj[2].x, topProj[2].y);
      ctx.lineTo(topProj[3].x, topProj[3].y);
      ctx.lineTo(bottomProj[3].x, bottomProj[3].y);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();

      // å³ä¾§é¢
      if (isPreview) {
        ctx.fillStyle = 'rgba(33, 150, 243, 0.2)';
      } else if (building.id === this.selectedBuildingId) {
        ctx.fillStyle = 'rgba(255, 152, 0, 0.5)';
      } else {
        ctx.fillStyle = this.isDarkMode ? 'rgba(66, 165, 245, 0.5)' : 'rgba(25, 118, 210, 0.5)';
      }
      ctx.beginPath();
      ctx.moveTo(bottomProj[1].x, bottomProj[1].y);
      ctx.lineTo(topProj[1].x, topProj[1].y);
      ctx.lineTo(topProj[2].x, topProj[2].y);
      ctx.lineTo(bottomProj[2].x, bottomProj[2].y);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();

      // é¡¶é¢
      if (isPreview) {
        ctx.fillStyle = 'rgba(33, 150, 243, 0.4)';
      } else if (building.id === this.selectedBuildingId) {
        ctx.fillStyle = 'rgba(255, 152, 0, 0.8)';
      } else {
        ctx.fillStyle = this.isDarkMode ? 'rgba(66, 165, 245, 0.8)' : 'rgba(25, 118, 210, 0.8)';
      }
      ctx.beginPath();
      ctx.moveTo(topProj[0].x, topProj[0].y);
      ctx.lineTo(topProj[1].x, topProj[1].y);
      ctx.lineTo(topProj[2].x, topProj[2].y);
      ctx.lineTo(topProj[3].x, topProj[3].y);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();

      // ç»˜åˆ¶æ¥¼å±‚çº¿
      if (!isPreview && building.height > building.floorHeight) {
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.lineWidth = 1;
        ctx.setLineDash([]);

        const floorCount = building.getFloorCount();
        for (let i = 1; i < floorCount; i++) {
          const h = i * building.floorHeight;
          
          // ç»˜åˆ¶å‰é¢çš„æ¥¼å±‚çº¿
          const p1: Point3D = { x: bottom[2].x, y: bottom[2].y, z: h };
          const p2: Point3D = { x: bottom[3].x, y: bottom[3].y, z: h };
          const fp1 = project(p1);
          const fp2 = project(p2);

          ctx.beginPath();
          ctx.moveTo(fp1.x, fp1.y);
          ctx.lineTo(fp2.x, fp2.y);
          ctx.stroke();
        }
      }

      // ç»˜åˆ¶å»ºç­‘ç‰©æ ‡ç­¾
      if (!isPreview) {
        ctx.setLineDash([]);
        // æ ¹æ®ä¸»é¢˜é€‰æ‹©æ–‡æœ¬é¢œè‰²
        ctx.fillStyle = this.isDarkMode ? '#000000' : '#FFFFFF';
        ctx.strokeStyle = this.isDarkMode ? '#FFFFFF' : '#000000';
        ctx.lineWidth = 3;
        ctx.font = 'bold 14px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        // åœ¨å»ºç­‘ç‰©é¡¶éƒ¨ä¸­å¿ƒæ˜¾ç¤ºæ ‡ç­¾
        const labelPos = project({ x: building.x, y: building.y, z: building.height + 5 });
        ctx.strokeText(`#${building.id}`, labelPos.x, labelPos.y);
        ctx.fillText(`#${building.id}`, labelPos.x, labelPos.y);
      }

      ctx.setLineDash([]);
    }
  }  /**
   * ç»˜åˆ¶å¸¦çƒ­åŠ›å›¾çš„3Då»ºç­‘ç‰©
   */
  private drawBuilding3DWithHeatmap(
    ctx: CanvasRenderingContext2D,
    building: BuildingModel,
    centerX: number,
    centerY: number,
    gridSize: number,
    scale: number,
    heightScale: number
  ) {
    const floorCount = building.getFloorCount();
    const unitCount = building.units;
    const floorHeight = building.floorHeight;
    
    // æŠ•å½±å‡½æ•°
    const project = (p: Point3D): Point2D => {
      const screenX = centerX + (p.x * gridSize * scale) + (p.y * gridSize * scale * 0.5);
      const screenY = centerY + (p.y * gridSize * scale * 0.5) - (p.x * gridSize * scale * 0.25) - (p.z * heightScale);
      return { x: screenX, y: screenY };
    };
    
    // å»ºç­‘ç‰©è§’ç‚¹
    const angle = building.rotationDeg * Math.PI / 180;
    const cosA = Math.cos(angle);
    const sinA = Math.sin(angle);
    const halfW = building.width / 2;
    const halfL = building.length / 2;
    
    const localCorners: Point2D[] = [
      { x: -halfW, y: -halfL },
      { x: halfW, y: -halfL },
      { x: halfW, y: halfL },
      { x: -halfW, y: halfL }
    ];
    
    const bottom: Point3D[] = [];
    const top: Point3D[] = [];
    for (const corner of localCorners) {
      const worldX = building.x + corner.x * cosA - corner.y * sinA;
      const worldY = building.y + corner.x * sinA + corner.y * cosA;
      bottom.push({ x: worldX, y: worldY, z: 0 });
      top.push({ x: worldX, y: worldY, z: building.height });
    }
    
    const bottomProj = bottom.map(project);
    const topProj = top.map(project);
    
    ctx.lineWidth = 1;
    ctx.setLineDash([]);
    
    // æŒ‰æ¥¼å±‚å’Œå•å…ƒç»˜åˆ¶
    for (let floor = 1; floor <= floorCount; floor++) {
      const z0 = (floor - 1) * floorHeight;
      const z1 = floor * floorHeight;
      
      // å‰é¢ (é¢å‘è§‚å¯Ÿè€…çš„é¢)
      for (let unit = 0; unit < unitCount; unit++) {
        // æŸ¥æ‰¾è¯¥å•å…ƒçš„æ—¥ç…§æ•°æ®
        const unitData = this.unitSunshineData.find(
          d => d.buildingId === building.id && d.floor === floor && d.unitIndex === unit
        );
        
        if (unitData) {
          // ä½¿ç”¨çƒ­åŠ›å›¾é¢œè‰²
          const color = unitData.getHeatmapColor();
          ctx.fillStyle = color.replace(')', ', 0.8)').replace('rgb', 'rgba');
          ctx.strokeStyle = color;
        } else {
          // é»˜è®¤é¢œè‰² - æ ¹æ®ä¸»é¢˜é€‰æ‹©
          if (this.isDarkMode) {
            ctx.fillStyle = 'rgba(66, 165, 245, 0.7)';
          } else {
            ctx.fillStyle = 'rgba(25, 118, 210, 0.7)';
          }
          ctx.strokeStyle = '#1976D2';
        }
        
        // è®¡ç®—å•å…ƒåœ¨å‰é¢çš„ä½ç½®
        const unitWidth = building.width / unitCount;
        const unitLeft = -building.width / 2 + unit * unitWidth;
        const unitRight = unitLeft + unitWidth;
        
        // å‰é¢çš„4ä¸ªè§’ç‚¹(æœ¬åœ°åæ ‡)
        const corners: Point2D[] = [
          { x: unitRight, y: building.length / 2 },  // å³ä¸‹
          { x: unitRight, y: building.length / 2 },  // å³ä¸Š
          { x: unitLeft, y: building.length / 2 },   // å·¦ä¸Š
          { x: unitLeft, y: building.length / 2 }    // å·¦ä¸‹
        ];
        
        // æŠ•å½±4ä¸ªè§’ç‚¹
        const points: Point2D[] = [];
        for (let i = 0; i < corners.length; i++) {
          const worldX = building.x + corners[i].x * cosA - corners[i].y * sinA;
          const worldY = building.y + corners[i].x * sinA + corners[i].y * cosA;
          const z = i < 2 ? z1 : z0;  // ä¸Šé¢ä¸¤ç‚¹ç”¨z1,ä¸‹é¢ä¸¤ç‚¹ç”¨z0
          points.push(project({ x: worldX, y: worldY, z: z }));
        }
        
        // ç»˜åˆ¶å•å…ƒçŸ©å½¢
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        ctx.lineTo(points[1].x, points[1].y);
        ctx.lineTo(points[2].x, points[2].y);
        ctx.lineTo(points[3].x, points[3].y);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
      }
    }
    
    // ç»˜åˆ¶å³ä¾§é¢(ç®€åŒ–å¤„ç†,ä¸åˆ†å•å…ƒ) - æ ¹æ®ä¸»é¢˜é€‰æ‹©é¢œè‰²
    ctx.fillStyle = this.isDarkMode ? 'rgba(66, 165, 245, 0.5)' : 'rgba(25, 118, 210, 0.5)';
    ctx.strokeStyle = '#1976D2';
    ctx.beginPath();
    ctx.moveTo(bottomProj[1].x, bottomProj[1].y);
    ctx.lineTo(topProj[1].x, topProj[1].y);
    ctx.lineTo(topProj[2].x, topProj[2].y);
    ctx.lineTo(bottomProj[2].x, bottomProj[2].y);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();
    
    // ç»˜åˆ¶é¡¶é¢ - æ ¹æ®ä¸»é¢˜é€‰æ‹©é¢œè‰²
    ctx.fillStyle = this.isDarkMode ? 'rgba(66, 165, 245, 0.8)' : 'rgba(25, 118, 210, 0.8)';
    ctx.strokeStyle = '#1976D2';
    ctx.beginPath();
    ctx.moveTo(topProj[0].x, topProj[0].y);
    ctx.lineTo(topProj[1].x, topProj[1].y);
    ctx.lineTo(topProj[2].x, topProj[2].y);
    ctx.lineTo(topProj[3].x, topProj[3].y);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();
    
    // ç»˜åˆ¶å»ºç­‘ç‰©æ ‡ç­¾ - æ ¹æ®ä¸»é¢˜é€‰æ‹©æ–‡æœ¬é¢œè‰²
    ctx.setLineDash([]);
    ctx.fillStyle = this.isDarkMode ? '#000000' : '#FFFFFF';
    ctx.strokeStyle = this.isDarkMode ? '#FFFFFF' : '#000000';
    ctx.lineWidth = 3;
    ctx.font = 'bold 14px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    const labelPos = project({ x: building.x, y: building.y, z: building.height + 5 });
    ctx.strokeText(`#${building.id}`, labelPos.x, labelPos.y);
    ctx.fillText(`#${building.id}`, labelPos.x, labelPos.y);
  }

  /**
   * ç»˜åˆ¶ç½‘æ ¼
   */
  private drawGrid(ctx: CanvasRenderingContext2D) {
    // ä½¿ç”¨èµ„æºé¢œè‰²ç»˜åˆ¶ç½‘æ ¼
    ctx.strokeStyle = this.canvasGridColor;
    ctx.lineWidth = 1;

    const gridSize = 40; // æ¯æ ¼40åƒç´ 
    const rows = Math.floor(this.canvasHeight / gridSize);
    const cols = Math.floor(this.canvasWidth / gridSize);

    // ç»˜åˆ¶æ°´å¹³çº¿
    for (let i = 0; i <= rows; i++) {
      ctx.beginPath();
      ctx.moveTo(0, i * gridSize);
      ctx.lineTo(this.canvasWidth, i * gridSize);
      ctx.stroke();
    }

    // ç»˜åˆ¶å‚ç›´çº¿
    for (let i = 0; i <= cols; i++) {
      ctx.beginPath();
      ctx.moveTo(i * gridSize, 0);
      ctx.lineTo(i * gridSize, this.canvasHeight);
      ctx.stroke();
    }
    
    // ç»˜åˆ¶ä¸­å¿ƒåå­—çº¿(åæ ‡åŸç‚¹)
    ctx.strokeStyle = this.canvasAccentColor;
    ctx.lineWidth = 2;
    const centerX = this.canvasWidth / 2;
    const centerY = this.canvasHeight / 2;
    
    // æ°´å¹³çº¿
    ctx.beginPath();
    ctx.moveTo(centerX - 20, centerY);
    ctx.lineTo(centerX + 20, centerY);
    ctx.stroke();
    
    // å‚ç›´çº¿
    ctx.beginPath();
    ctx.moveTo(centerX, centerY - 20);
    ctx.lineTo(centerX, centerY + 20);
    ctx.stroke();
    
    // æ ‡æ³¨æ–¹ä½
    ctx.fillStyle = this.canvasAccentColor;
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('åŒ—', centerX, centerY - 30);
    ctx.fillText('å—', centerX, centerY + 30);
    ctx.fillText('è¥¿', centerX - 30, centerY);
    ctx.fillText('ä¸œ', centerX + 30, centerY);
  }

  /**
   * ç»˜åˆ¶2Då»ºç­‘ç‰©
   */
  private drawBuilding2D(ctx: CanvasRenderingContext2D, building: BuildingModel, isPreview: boolean) {
    const gridSize = 40; // æ¯æ ¼40åƒç´ ,ä¸drawGridä¿æŒä¸€è‡´
    
    // å»ºç­‘ç‰©ä¸­å¿ƒä½ç½®(é€»è¾‘å•ä½)
    const centerX = building.x;
    const centerY = building.y;
    
    // å»ºç­‘ç‰©å°ºå¯¸(é€»è¾‘å•ä½)
    const width = building.width;
    const length = building.length;
    
    // è½¬æ¢ä¸ºç”»å¸ƒåæ ‡(å·¦ä¸Šè§’ä¸ºåŸç‚¹)
    const canvasCenterX = this.canvasWidth / 2 + centerX * gridSize;
    const canvasCenterY = this.canvasHeight / 2 + centerY * gridSize;
    
    const pixelWidth = width * gridSize;
    const pixelLength = length * gridSize;
    
    // è€ƒè™‘æ—‹è½¬
    ctx.save();
    ctx.translate(canvasCenterX, canvasCenterY);
    ctx.rotate(building.rotationDeg * Math.PI / 180);
    
    // ç»˜åˆ¶å»ºç­‘ç‰©çŸ©å½¢
    if (isPreview) {
      // é¢„è§ˆæ ·å¼:åŠé€æ˜è“è‰²
      ctx.fillStyle = 'rgba(33, 150, 243, 0.3)';
      ctx.strokeStyle = '#2196F3';
      ctx.lineWidth = 2;
      ctx.setLineDash([8, 4]);  // è™šçº¿
    } else {
      // æ­£å¸¸æ ·å¼ - ä½¿ç”¨èµ„æºé¢œè‰²
      ctx.fillStyle = this.selectedBuildingId === building.id 
        ? this.canvasBuildingSelectedColor 
        : this.canvasBuildingColor;
      ctx.strokeStyle = this.canvasBuildingBorderColor;
      ctx.lineWidth = 2;
      ctx.setLineDash([]);  // å®çº¿
    }
    
    ctx.fillRect(-pixelWidth / 2, -pixelLength / 2, pixelWidth, pixelLength);
    ctx.strokeRect(-pixelWidth / 2, -pixelLength / 2, pixelWidth, pixelLength);
    
    if (!isPreview) {
      // ç»˜åˆ¶å•å…ƒåˆ†éš”çº¿
      if (building.units > 1) {
        ctx.strokeStyle = this.canvasBuildingBorderColor;
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 2]);  // è™šçº¿
        const unitWidth = pixelWidth / building.units;
        
        for (let i = 1; i < building.units; i++) {
          const x = -pixelWidth / 2 + i * unitWidth;
          ctx.beginPath();
          ctx.moveTo(x, -pixelLength / 2);
          ctx.lineTo(x, pixelLength / 2);
          ctx.stroke();
        }
        ctx.setLineDash([]);  // æ¢å¤å®çº¿
      }
      
      // ç»˜åˆ¶å•å…ƒç¼–å·(ä»å³åˆ°å·¦)
      ctx.fillStyle = this.canvasTextColor;
      ctx.font = '12px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      const unitWidth = pixelWidth / building.units;
      
      for (let i = 0; i < building.units; i++) {
        const unitNumber = building.units - i;  // ä»å³åˆ°å·¦ç¼–å·
        const x = -pixelWidth / 2 + (i + 0.5) * unitWidth;
        const y = 0;
        
        // å¦‚æœæ˜¯ç›®æ ‡å•å…ƒä¸”æ˜¯ç›®æ ‡å»ºç­‘,é«˜äº®æ˜¾ç¤º
        const isTargetUnit = (building.id === this.targetBuildingId && unitNumber === this.targetUnit);
        if (isTargetUnit) {
          ctx.fillStyle = '#FF9800';
          ctx.font = 'bold 14px sans-serif';
        } else {
          ctx.fillStyle = this.canvasTextColor;
          ctx.font = '12px sans-serif';
        }
        
        ctx.fillText(`${unitNumber}`, x, y);
      }
      
      // ç»˜åˆ¶å»ºç­‘ç‰©IDåœ¨é¡¶éƒ¨
      ctx.fillStyle = this.canvasTextColor;
      ctx.font = 'bold 14px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(`#${building.id}`, 0, -pixelLength / 2 + 15);
      
      // ç»˜åˆ¶æœå‘æŒ‡ç¤º(ä¸€ä¸ªå°ç®­å¤´æŒ‡å‘å—)
      ctx.strokeStyle = this.canvasAccentColor;
      ctx.lineWidth = 2;
      ctx.setLineDash([]);  // å®çº¿ç®­å¤´
      ctx.beginPath();
      ctx.moveTo(0, -pixelLength / 2);
      ctx.lineTo(0, -pixelLength / 2 - 15);
      ctx.lineTo(-5, -pixelLength / 2 - 10);
      ctx.moveTo(0, -pixelLength / 2 - 15);
      ctx.lineTo(5, -pixelLength / 2 - 10);
      ctx.stroke();
    } else {
      // é¢„è§ˆæ—¶æ˜¾ç¤ºå°ºå¯¸ä¿¡æ¯
      ctx.fillStyle = '#2196F3';
      ctx.font = '12px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      const widthM = (width * this.scaleMetersPerCell).toFixed(1);
      const lengthM = (length * this.scaleMetersPerCell).toFixed(1);
      ctx.fillText(`${widthM}m Ã— ${lengthM}m`, 0, 0);
    }
    
    ctx.restore();
  }

  /**
   * ç»˜åˆ¶é¢„è§ˆå»ºç­‘ç‰©
   */
  private drawPreviewBuilding(ctx: CanvasRenderingContext2D) {
    if (!ctx) {
      return;
    }
    
    // åˆ›å»ºä¸´æ—¶å»ºç­‘ç‰©ç”¨äºé¢„è§ˆ
    const previewBuilding = new BuildingModel();
    previewBuilding.id = 0;  // é¢„è§ˆIDä¸º0
    previewBuilding.x = this.previewX;
    previewBuilding.y = this.previewY;
    previewBuilding.width = this.pendingWidth / this.scaleMetersPerCell;
    previewBuilding.length = this.pendingLength / this.scaleMetersPerCell;
    previewBuilding.height = this.pendingHeight;
    previewBuilding.floorHeight = this.pendingFloorHeight;
    previewBuilding.units = this.pendingUnits;
    previewBuilding.rotationDeg = this.pendingRotation;
    
    this.drawBuilding2D(ctx, previewBuilding, true);
    
    // ç»˜åˆ¶åå­—å‡†æ˜Ÿ
    const gridSize = 40;
    const canvasCenterX = this.canvasWidth / 2 + this.previewX * gridSize;
    const canvasCenterY = this.canvasHeight / 2 + this.previewY * gridSize;
    
    ctx.save();
    ctx.strokeStyle = '#F44336';
    ctx.lineWidth = 1;
    ctx.setLineDash([4, 2]);
    
    // æ¨ªçº¿
    ctx.beginPath();
    ctx.moveTo(canvasCenterX - 15, canvasCenterY);
    ctx.lineTo(canvasCenterX + 15, canvasCenterY);
    ctx.stroke();
    
    // ç«–çº¿
    ctx.beginPath();
    ctx.moveTo(canvasCenterX, canvasCenterY - 15);
    ctx.lineTo(canvasCenterX, canvasCenterY + 15);
    ctx.stroke();
    
    ctx.restore();
  }

  /**
   * åŠ è½½é»˜è®¤å»ºç­‘ç‰©
   */
  private loadDefaultBuildings() {
    // ä¸åŠ è½½é»˜è®¤å»ºç­‘ç‰©,è®©ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ 
    this.buildings = [];
    this.nextBuildingId = 1;
  }

  /**
   * å¼€å§‹æ”¾ç½®å»ºç­‘ç‰©
   */
  private startPlacingBuilding() {
    this.isPlacingBuilding = !this.isPlacingBuilding;
    if (!this.isPlacingBuilding) {
      // å–æ¶ˆæ”¾ç½®æ—¶éšè—é¢„è§ˆ
      this.showPreview = false;
      this.redraw();
    } else {
      // å¼€å§‹æ”¾ç½®æ—¶
      // åˆå§‹åŒ–é¢„è§ˆä½ç½®ä¸ºä¸­å¿ƒ
      this.previewX = 0;
      this.previewY = 0;
      this.showPreview = true;
      
      // å¦‚æœæ˜¯å°å±å¹•åˆ™è‡ªåŠ¨åˆ‡æ¢åˆ°ç”»å¸ƒè§†å›¾
      if (this.isSmallScreen) {
        this.showControlPanel = false;
        // å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿Canvaså·²ç»æ¸²æŸ“
        setTimeout(() => {
          this.redraw();
        }, 100);
      } else {
        // å¤§å±å¹•ç›´æ¥ç»˜åˆ¶
        this.redraw();
      }
    }
  }
  
  /**
   * å¤„ç†Canvasè§¦æ‘¸äº‹ä»¶
   */
  private handleCanvasTouch(event: TouchEvent) {
    if (!event.touches || event.touches.length === 0) {
      return;
    }

    const touch = event.touches[0];
    const x = touch.x;
    const y = touch.y;

    if (event.type === TouchType.Down) {
      this.handleTouchDown(x, y);
    } else if (event.type === TouchType.Move) {
      this.handleTouchMove(x, y);
    } else if (event.type === TouchType.Up) {
      this.handleTouchUp(x, y);
    }
  }

  /**
   * å¤„ç†Canvasé¼ æ ‡äº‹ä»¶
   */
  private handleCanvasMouse(event: MouseEvent) {
    const x = event.x;
    const y = event.y;

    if (event.action === MouseAction.Press) {
      // é¼ æ ‡æŒ‰ä¸‹
      this.handleTouchDown(x, y);
    } else if (event.action === MouseAction.Move) {
      // é¼ æ ‡æ‹–åŠ¨(æŒ‰ä½æŒ‰é’®ç§»åŠ¨)
      this.handleTouchMove(x, y);
    } else if (event.action === MouseAction.Release) {
      // é¼ æ ‡é‡Šæ”¾
      this.handleTouchUp(x, y);
    } else if (event.action === MouseAction.Hover) {
      // é¼ æ ‡æ‚¬åœ(æœªæŒ‰ä¸‹æŒ‰é’®ç§»åŠ¨)
      // åœ¨æ”¾ç½®æ¨¡å¼ä¸‹,éœ€è¦å®æ—¶æ›´æ–°é¢„è§ˆä½ç½®
      if (this.isPlacingBuilding) {
        this.handleTouchMove(x, y);
      }
    }
  }

  /**
   * å¤„ç†è§¦æ‘¸å¼€å§‹
   */
  private handleTouchDown(x: number, y: number) {
    if (this.isPlacingBuilding) {
      // æ”¾ç½®æ¨¡å¼,ä¸å¤„ç†æ‹–åŠ¨
      return;
    }

    // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å»ºç­‘ç‰©
    const building = this.hitTestBuilding(x, y);
    if (building) {
      this.selectBuilding(building.id);
      this.isDragging = true;
      this.dragStartX = x;
      this.dragStartY = y;
      this.dragBuildingStartX = building.x;
      this.dragBuildingStartY = building.y;
    }
  }

  /**
   * å¤„ç†è§¦æ‘¸ç§»åŠ¨
   */
  private handleTouchMove(x: number, y: number) {
    if (this.isPlacingBuilding) {
      // æ”¾ç½®æ¨¡å¼,æ›´æ–°é¢„è§ˆä½ç½®
      const gridSize = 40;
      const newPreviewX = (x - this.canvasWidth / 2) / gridSize;
      const newPreviewY = (y - this.canvasHeight / 2) / gridSize;
      
      // åªæœ‰ä½ç½®çœŸæ­£æ”¹å˜æ—¶æ‰æ›´æ–°
      if (Math.abs(newPreviewX - this.previewX) > 0.1 || Math.abs(newPreviewY - this.previewY) > 0.1) {
        this.previewX = newPreviewX;
        this.previewY = newPreviewY;
        this.showPreview = true;
        this.redrawThrottled();
      }
      return;
    }
    
    if (this.isDragging && this.selectedBuildingId !== null) {
      const building = this.buildings.find(b => b.id === this.selectedBuildingId);
      if (building) {
        // 3Dè§†å›¾ä¸‹éœ€è¦æ ¹æ®æŠ•å½±åç®—åæ ‡å˜åŒ–
        if (this.viewMode === '3d') {
          const gridSize = 80;
          const scale = 1.2;
          const centerX = this.canvasWidth / 2;
          const centerY = this.canvasHeight / 2;
          
          // ç®€åŒ–å¤„ç†:å°†å±å¹•ç§»åŠ¨é‡è½¬æ¢ä¸ºé€»è¾‘åæ ‡ç§»åŠ¨é‡
          // ç­‰è½´æµ‹æŠ•å½±: screenX = centerX + (worldX * gridSize * scale) + (worldY * gridSize * scale * 0.5)
          // ç®€åŒ–åç®—: ä¸»è¦è€ƒè™‘Xæ–¹å‘ç§»åŠ¨
          const screenDeltaX = x - this.dragStartX;
          const screenDeltaY = y - this.dragStartY;
          
          // ç²—ç•¥åç®—ä¸–ç•Œåæ ‡å˜åŒ–
          const worldDeltaX = (screenDeltaX - screenDeltaY * 0.5) / (gridSize * scale);
          const worldDeltaY = screenDeltaY / (gridSize * scale * 0.5);
          
          building.x = this.dragBuildingStartX + worldDeltaX;
          building.y = this.dragBuildingStartY + worldDeltaY;
        } else {
          // 2Dè§†å›¾
          const gridSize = 40;
          const deltaX = (x - this.dragStartX) / gridSize;
          const deltaY = (y - this.dragStartY) / gridSize;
          
          building.x = this.dragBuildingStartX + deltaX;
          building.y = this.dragBuildingStartY + deltaY;
        }
        
        this.redrawThrottled();
      }
    }
  }

  /**
   * å¤„ç†è§¦æ‘¸ç»“æŸ
   */
  private handleTouchUp(x: number, y: number) {
    if (this.isPlacingBuilding) {
      // æ”¾ç½®æ¨¡å¼
      this.placeBuilding(x, y);
      return;
    }

    if (this.isDragging) {
      this.isDragging = false;
      // æ‹–åŠ¨ç»“æŸåä¿å­˜
      this.saveToStorage();
    } else {
      // å•å‡»é€‰æ‹©å»ºç­‘ç‰©å’Œå•å…ƒ
      const result = this.hitTestBuildingUnit(x, y);
      if (result) {
        this.selectBuilding(result.building.id);
        // è‡ªåŠ¨è®¾ç½®ç‚¹å‡»çš„å•å…ƒä¸ºç›®æ ‡å•å…ƒ
        this.targetUnit = result.unit;
        console.info(`ç‚¹å‡»äº†å»ºç­‘ç‰© #${result.building.id} çš„å•å…ƒ ${result.unit}`);
        this.redraw();  // é‡ç»˜ä»¥æ˜¾ç¤ºé«˜äº®
      }
    }
  }

  /**
   * ç¢°æ’æ£€æµ‹ - æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨å»ºç­‘ç‰©å†…,å¹¶è¿”å›å•å…ƒç¼–å·
   */
  private hitTestBuildingUnit(clickX: number, clickY: number): BuildingUnitHitResult | null {
    if (this.viewMode === '3d') {
      return this.hitTestBuildingUnit3D(clickX, clickY);
    }
    
    const gridSize = 40;
    
    // è½¬æ¢ä¸ºé€»è¾‘åæ ‡
    const logicalX = (clickX - this.canvasWidth / 2) / gridSize;
    const logicalY = (clickY - this.canvasHeight / 2) / gridSize;
    
    // ä»åå‘å‰éå†(åç»˜åˆ¶çš„åœ¨ä¸Šå±‚)
    for (let i = this.buildings.length - 1; i >= 0; i--) {
      const building = this.buildings[i];
      
      // è€ƒè™‘æ—‹è½¬çš„ç¢°æ’æ£€æµ‹
      const rad = -building.rotationDeg * Math.PI / 180;  // åå‘æ—‹è½¬
      const dx = logicalX - building.x;
      const dy = logicalY - building.y;
      
      // æ—‹è½¬ç‚¹å‡»ä½ç½®åˆ°å»ºç­‘ç‰©æœ¬åœ°åæ ‡ç³»
      const localX = dx * Math.cos(rad) - dy * Math.sin(rad);
      const localY = dx * Math.sin(rad) + dy * Math.cos(rad);
      
      // æ£€æŸ¥æ˜¯å¦åœ¨çŸ©å½¢å†…
      if (Math.abs(localX) <= building.width / 2 && Math.abs(localY) <= building.length / 2) {
        // è®¡ç®—ç‚¹å‡»çš„å•å…ƒç¼–å·(ä»å³åˆ°å·¦)
        const unitWidth = building.width / building.units;
        const relativeX = localX + building.width / 2;  // è½¬æ¢ä¸ºä»å·¦è¾¹å¼€å§‹çš„åæ ‡
        const unitIndex = Math.floor(relativeX / unitWidth);  // 0-based index from left
        const unitNumber = building.units - unitIndex;  // ä»å³åˆ°å·¦ç¼–å·,1-based
        
        const result: BuildingUnitHitResult = {
          building: building,
          unit: Math.max(1, Math.min(building.units, unitNumber))
        };
        return result;
      }
    }
    
    return null;
  }

  /**
   * 3Dè§†å›¾çš„ç¢°æ’æ£€æµ‹
   */
  private hitTestBuildingUnit3D(clickX: number, clickY: number): BuildingUnitHitResult | null {
    const gridSize = 80; // ä¸3Dç»˜åˆ¶ä¿æŒä¸€è‡´
    const scale = 1.2;
    const centerX = this.canvasWidth / 2;
    const centerY = this.canvasHeight / 2;
    
    // ä»åå‘å‰éå†
    for (let i = this.buildings.length - 1; i >= 0; i--) {
      const building = this.buildings[i];
      
      // å»ºç­‘ç‰©æ—‹è½¬
      const angle = building.rotationDeg * Math.PI / 180;
      const cosA = Math.cos(angle);
      const sinA = Math.sin(angle);
      
      // å»ºç­‘ç‰©4ä¸ªåº•éƒ¨è§’ç‚¹
      const halfW = building.width / 2;
      const halfL = building.length / 2;
      
      const localCorners: Point2D[] = [
        { x: -halfW, y: -halfL },
        { x: halfW, y: -halfL },
        { x: halfW, y: halfL },
        { x: -halfW, y: halfL }
      ];
      
      // æŠ•å½±åˆ°å±å¹•åæ ‡
      const screenCorners: Point2D[] = [];
      for (const corner of localCorners) {
        const worldX = building.x + corner.x * cosA - corner.y * sinA;
        const worldY = building.y + corner.x * sinA + corner.y * cosA;
        
        const screenX = centerX + (worldX * gridSize * scale) + (worldY * gridSize * scale * 0.5);
        const screenY = centerY + (worldY * gridSize * scale * 0.5) - (worldX * gridSize * scale * 0.25);
        
        screenCorners.push({ x: screenX, y: screenY });
      }
      
      // ä½¿ç”¨å°„çº¿æ³•åˆ¤æ–­ç‚¹æ˜¯å¦åœ¨å¤šè¾¹å½¢å†…
      if (this.isPointInPolygon(clickX, clickY, screenCorners)) {
        // ç®€åŒ–:è¿”å›å•å…ƒ1(å¯ä»¥åç»­ä¼˜åŒ–)
        const result: BuildingUnitHitResult = {
          building: building,
          unit: 1
        };
        return result;
      }
    }
    
    return null;
  }

  /**
   * å°„çº¿æ³•åˆ¤æ–­ç‚¹æ˜¯å¦åœ¨å¤šè¾¹å½¢å†…
   */
  private isPointInPolygon(x: number, y: number, polygon: Point2D[]): boolean {
    let inside = false;
    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
      const xi = polygon[i].x;
      const yi = polygon[i].y;
      const xj = polygon[j].x;
      const yj = polygon[j].y;
      
      const intersect = ((yi > y) !== (yj > y)) && 
                       (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
      if (intersect) {
        inside = !inside;
      }
    }
    return inside;
  }

  /**
   * ç¢°æ’æ£€æµ‹ - æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨å»ºç­‘ç‰©å†…
   */
  private hitTestBuilding(clickX: number, clickY: number): BuildingModel | null {
    const result = this.hitTestBuildingUnit(clickX, clickY);
    return result ? result.building : null;
  }

  /**
   * é€‰æ‹©å»ºç­‘ç‰©
   */
  private selectBuilding(id: number) {
    this.selectedBuildingId = id;
    const building = this.buildings.find(b => b.id === id);
    
    if (building) {
      // æ›´æ–°ç¼–è¾‘é¢æ¿çš„å‚æ•°
      this.pendingWidth = building.width * this.scaleMetersPerCell;  // è½¬æ¢ä¸ºç±³
      this.pendingLength = building.length * this.scaleMetersPerCell;
      this.pendingHeight = building.height;
      this.pendingFloorHeight = building.floorHeight;
      this.pendingUnits = building.units;
      this.pendingRotation = building.rotationDeg;
      
      // è‡ªåŠ¨è®¾ç½®ä¸ºç›®æ ‡å»ºç­‘
      this.targetBuildingId = id;
      this.updateTargetFloorOptions();
      
      console.info(`é€‰ä¸­å»ºç­‘ç‰© #${id}`);
    }
    
    this.redraw();
  }

  /**
   * æ›´æ–°é€‰ä¸­å»ºç­‘ç‰©çš„å‚æ•°
   */
  private updateSelectedBuilding() {
    if (this.selectedBuildingId === null) {
      return;
    }
    
    const building = this.buildings.find(b => b.id === this.selectedBuildingId);
    if (building) {
      // ä»ç±³è½¬æ¢ä¸ºé€»è¾‘å•ä½
      building.width = this.pendingWidth / this.scaleMetersPerCell;
      building.length = this.pendingLength / this.scaleMetersPerCell;
      building.height = this.pendingHeight;
      building.floorHeight = this.pendingFloorHeight;
      building.units = this.pendingUnits;
      building.rotationDeg = this.pendingRotation;
      
      this.saveToStorage();
      this.redraw();
    }
  }

  /**
   * åˆ é™¤é€‰ä¸­çš„å»ºç­‘ç‰©
   */
  private deleteSelectedBuilding() {
    if (this.selectedBuildingId === null) {
      return;
    }
    
    this.buildings = this.buildings.filter(b => b.id !== this.selectedBuildingId);
    console.info(`åˆ é™¤å»ºç­‘ç‰© #${this.selectedBuildingId}`);
    this.selectedBuildingId = null;
    this.updateTargetBuildingOptions();
    this.saveToStorage();
    this.redraw();
  }

  /**
   * æ›´æ–°ç›®æ ‡å»ºç­‘ä¸‹æ‹‰é€‰é¡¹
   */
  private updateTargetBuildingOptions() {
    this.targetBuildingOptions = this.buildings.map(b => `#${b.id}`);
    
    if (this.buildings.length > 0) {
      // ç¡®ä¿å½“å‰é€‰æ‹©çš„å»ºç­‘å­˜åœ¨
      const exists = this.buildings.find(b => b.id === this.targetBuildingId);
      if (!exists) {
        this.targetBuildingId = this.buildings[0].id;
      }
      this.updateTargetFloorOptions();
    } else {
      this.targetFloorOptions = [];
      this.targetUnitOptions = [];
    }
  }

  /**
   * æ›´æ–°ç›®æ ‡æ¥¼å±‚å’Œå•å…ƒä¸‹æ‹‰é€‰é¡¹
   */
  private updateTargetFloorOptions() {
    const building = this.buildings.find((b: BuildingModel) => b.id === this.targetBuildingId);
    if (building) {
      const maxFloor = Math.floor(building.height / building.floorHeight);
      this.targetFloorOptions = Array.from<number, string>({ length: maxFloor }, (_: number, i: number): string => (i + 1).toString());
      
      // ç¡®ä¿å½“å‰æ¥¼å±‚åœ¨èŒƒå›´å†…
      if (this.targetFloor > maxFloor) {
        this.targetFloor = maxFloor;
      } else if (this.targetFloor < 1) {
        this.targetFloor = 1;
      }
      
      // æ›´æ–°å•å…ƒé€‰é¡¹
      this.targetUnitOptions = Array.from<number, string>({ length: building.units }, (_: number, i: number): string => (i + 1).toString());
      
      // ç¡®ä¿å½“å‰å•å…ƒåœ¨èŒƒå›´å†…
      if (this.targetUnit > building.units) {
        this.targetUnit = building.units;
      } else if (this.targetUnit < 1) {
        this.targetUnit = 1;
      }
    } else {
      this.targetFloorOptions = [];
      this.targetUnitOptions = [];
    }
  }

  /**
   * åœ¨ç”»å¸ƒä¸Šæ”¾ç½®å»ºç­‘ç‰©
   */
  private placeBuilding(clickX: number, clickY: number) {
    const gridSize = 40;
    
    // å°†ç‚¹å‡»åæ ‡è½¬æ¢ä¸ºé€»è¾‘å•ä½(ä»¥æ ¼å­ä¸ºå•ä½)
    const gridX = (clickX - this.canvasWidth / 2) / gridSize;
    const gridY = (clickY - this.canvasHeight / 2) / gridSize;
    
    // åˆ›å»ºæ–°å»ºç­‘,ä½¿ç”¨ç¼–è¾‘é¢æ¿çš„å‚æ•°
    const building = new BuildingModel();
    building.id = this.nextBuildingId++;
    building.x = gridX;
    building.y = gridY;
    building.width = this.pendingWidth / this.scaleMetersPerCell;  // ç±³è½¬é€»è¾‘å•ä½
    building.length = this.pendingLength / this.scaleMetersPerCell;
    building.height = this.pendingHeight;
    building.floorHeight = this.pendingFloorHeight;
    building.units = this.pendingUnits;
    building.rotationDeg = this.pendingRotation;
    
    this.buildings.push(building);
    
    // æ›´æ–°ç›®æ ‡å»ºç­‘ä¸‹æ‹‰é€‰é¡¹
    this.updateTargetBuildingOptions();
    
    this.selectedBuildingId = building.id;  // è‡ªåŠ¨é€‰ä¸­æ–°å»ºç­‘ç‰©
    this.isPlacingBuilding = false; // æ”¾ç½®åé€€å‡ºæ”¾ç½®æ¨¡å¼
    this.showPreview = false;  // éšè—é¢„è§ˆ
    
    // å°å±å¹•æ¨¡å¼ä¸‹è‡ªåŠ¨åˆ‡æ¢å›è®¾ç½®é¢æ¿
    if (this.isSmallScreen) {
      this.showControlPanel = true;
    }
    
    console.info(`å·²æ”¾ç½®å»ºç­‘ç‰© #${building.id}:
      ç‚¹å‡»ä½ç½®: (${clickX.toFixed(1)}, ${clickY.toFixed(1)})
      é€»è¾‘ä½ç½®: (${gridX.toFixed(2)}, ${gridY.toFixed(2)})
      å°ºå¯¸(ç±³): ${this.pendingWidth} x ${this.pendingLength} x ${this.pendingHeight}
      å½“å‰å»ºç­‘ç‰©æ€»æ•°: ${this.buildings.length}`);
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    this.saveToStorage();
    
    // é‡ç»˜ç”»å¸ƒ
    this.redraw();
  }

  /**
   * ç§»é™¤å»ºç­‘ç‰©
   */
  private removeBuilding(id: number) {
    this.buildings = this.buildings.filter(b => b.id !== id);
    if (this.selectedBuildingId === id) {
      this.selectedBuildingId = null;
    }
    this.redraw();
  }

  /**
   * è®¡ç®—æ—¥ç…§
   */
  private calculateSunshine() {
    // éªŒè¯è¾“å…¥
    if (this.buildings.length === 0) {
      console.error('æ²¡æœ‰å»ºç­‘ç‰©');
      return;
    }

    // æŸ¥æ‰¾ç›®æ ‡å»ºç­‘
    const targetBuilding = this.buildings.find(b => b.id === this.targetBuildingId);
    if (!targetBuilding) {
      console.error('æœªæ‰¾åˆ°ç›®æ ‡å»ºç­‘');
      return;
    }

    // éªŒè¯æ¥¼å±‚å’Œå•å…ƒ
    const maxFloor = targetBuilding.getFloorCount();
    if (this.targetFloor < 1 || this.targetFloor > maxFloor) {
      console.error(`æ¥¼å±‚å¿…é¡»åœ¨1-${maxFloor}ä¹‹é—´`);
      return;
    }

    if (this.targetUnit < 1 || this.targetUnit > targetBuilding.units) {
      console.error(`å•å…ƒå¿…é¡»åœ¨1-${targetBuilding.units}ä¹‹é—´`);
      return;
    }

    this.calculating = true;
    this.showResult = false;
    this.calculationResult = null;

    // ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡é¿å…é˜»å¡UI
    setTimeout(() => {
      const startTime = Date.now();
      try {
        // è°ƒç”¨é«˜çº§è¯„ä¼°å™¨
        this.calculationResult = this.calculator.calculateUnitSunshine(
          this.buildings,
          targetBuilding,
          this.targetFloor,
          this.targetUnit,
          this.latitude,
          this.longitude,
          this.scaleMetersPerCell,
          5 // 5åˆ†é’Ÿæ­¥é•¿
        );
        
        // è®¡ç®—è¯„åˆ† (æ ¹æ®å¹´å¹³å‡å€¼ä¼°ç®—å…¨å¹´æ€»æ—¥ç…§)
        const totalSunshineHours = this.calculationResult.annualAverage * 365;
        const specialDays: SpecialDays = {
          dahan: this.calculationResult.greatCold,
          dongzhi: this.calculationResult.winterSolstice,
          chunfen: this.calculationResult.springEquinox,
          xiazhi: this.calculationResult.summerSolstice,
          qiufen: this.calculationResult.autumnalEquinox
        };
        this.ratingResult = SunshineRatingSystem.evaluateAdvanced(totalSunshineHours, specialDays);
        
        this.showResult = true;
        
        const duration = Date.now() - startTime;
        console.info(`é«˜çº§è®¡ç®—å®Œæˆ,è€—æ—¶: ${duration}ms`);
        console.info(`ç»“æœ: æ˜¥åˆ†=${this.calculationResult.springEquinox.toFixed(2)}h, ` +
                     `å¤è‡³=${this.calculationResult.summerSolstice.toFixed(2)}h, ` +
                     `ç§‹åˆ†=${this.calculationResult.autumnalEquinox.toFixed(2)}h, ` +
                     `å†¬è‡³=${this.calculationResult.winterSolstice.toFixed(2)}h, ` +
                     `å¹´å‡=${this.calculationResult.annualAverage.toFixed(2)}h/å¤©`);
      } catch (error) {
        console.error('è®¡ç®—æ—¥ç…§æ—¶å‡ºé”™:', JSON.stringify(error));
      } finally {
        this.calculating = false;
      }
    }, 100);
  }

  /**
   * è®¡ç®—æŒ‡å®šå»ºç­‘æ‰€æœ‰å•å…ƒçš„æ—¥ç…§
   */
  private calculateAllUnits() {
    // éªŒè¯è¾“å…¥
    if (this.buildings.length === 0) {
      console.error('æ²¡æœ‰å»ºç­‘ç‰©');
      return;
    }

    // æŸ¥æ‰¾ç›®æ ‡å»ºç­‘
    const targetBuilding = this.buildings.find(b => b.id === this.targetBuildingId);
    if (!targetBuilding) {
      console.error('æœªæ‰¾åˆ°ç›®æ ‡å»ºç­‘');
      return;
    }

    this.calculating = true;
    this.showUnitView = false;
    this.unitSunshineData = [];
    this.calculatedUnits = 0;
    
    // è®¡ç®—æ€»å•å…ƒæ•°
    const totalFloors = Math.floor(targetBuilding.height / targetBuilding.floorHeight);
    this.totalUnitsToCalculate = totalFloors * targetBuilding.units;
    this.calculationProgress = 'å‡†å¤‡è®¡ç®—...';

    // ä½¿ç”¨åˆ†å—å¼‚æ­¥è®¡ç®—é¿å…é˜»å¡UI
    const startTime = Date.now();
    
    // åˆ†å—å¤§å°:æ¯æ¬¡å¤„ç†4ä¸ªå•å…ƒ(é™ä½æ‰¹æ¬¡å¤§å°ä»¥è·å¾—æ›´å¹³æ»‘çš„è¿›åº¦)
    const chunkSize = 4;
    let currentFloor = 1;
    let currentUnit = 1;  // unitIndexä»1å¼€å§‹
    const resultData: UnitSunshineData[] = [];
    
    // åˆ†å—è®¡ç®—å‡½æ•°
    const processChunk = () => {
      try {
        let processed = 0;
        
        // å¤„ç†ä¸€ä¸ªå—
        while (processed < chunkSize && currentFloor <= totalFloors) {
          // ä½¿ç”¨AdvancedSunshineCalculatorè®¡ç®—å•å…ƒæ—¥ç…§(ä¸å•ä¸€å•å…ƒè®¡ç®—ä¿æŒä¸€è‡´)
          const calcResult = this.calculator.calculateUnitSunshine(
            this.buildings,
            targetBuilding,
            currentFloor,
            currentUnit,
            this.latitude,
            this.longitude,
            this.scaleMetersPerCell,
            15  // ä½¿ç”¨15åˆ†é’Ÿæ­¥é•¿ä»¥æé«˜é€Ÿåº¦
          );
          
          // è½¬æ¢ä¸ºUnitSunshineDataæ ¼å¼
          const data = new UnitSunshineData();
          data.buildingId = targetBuilding.id;
          data.floor = currentFloor;
          data.unitIndex = currentUnit - 1;  // è¡¨æ ¼æ˜¾ç¤ºç”¨0-basedç´¢å¼•
          
          // è®¡ç®—å•å…ƒä¸­å¿ƒç‚¹åæ ‡
          const unitWidth = targetBuilding.width / targetBuilding.units;
          data.x = targetBuilding.x + (currentUnit - 1) * unitWidth + unitWidth / 2;
          data.y = targetBuilding.y + targetBuilding.length / 2;
          data.z = (currentFloor - 0.5) * targetBuilding.floorHeight;
          
          // è®¾ç½®æ—¥ç…§æ•°æ®ï¼ˆä¸è®¡ç®—æ—¥ç…§è¾“å‡ºä¿æŒä¸€è‡´ï¼‰
          data.springEquinoxSunshine = calcResult.springEquinox;
          data.summerSolsticeSunshine = calcResult.summerSolstice;
          data.autumnEquinoxSunshine = calcResult.autumnalEquinox;
          data.winterSolsticeSunshine = calcResult.winterSolstice;
          data.greatColdSunshine = calcResult.greatCold;
          data.averageDailySunshine = calcResult.annualAverage;  // å¹´å‡æ¯æ—¥æ—¥ç…§
          data.totalSunshineHours = calcResult.annualAverage * 365;  // å¹´å‡æ—¥ç…§*365å¤©
          
          resultData.push(data);
          
          this.calculatedUnits++;
          processed++;
          
          // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå•å…ƒ
          currentUnit++;
          if (currentUnit > targetBuilding.units) {
            currentUnit = 1;
            currentFloor++;
          }
        }
        
        // æ›´æ–°è¿›åº¦
        this.calculationProgress = `æ­£åœ¨è®¡ç®— ${currentFloor}/${totalFloors} æ¥¼...`;
        
        // å¦‚æœè¿˜æœ‰æœªå¤„ç†çš„å•å…ƒ,ç»§ç»­ä¸‹ä¸€å—
        if (currentFloor <= totalFloors) {
          setTimeout(processChunk, 50); // 50mså»¶è¿Ÿ,ç»™UIåˆ·æ–°æ—¶é—´
        } else {
          // è®¡ç®—å®Œæˆ
          this.unitSunshineData = resultData;
          this.showUnitView = true;
          this.activeUnitView = 'table';
          
          const duration = Date.now() - startTime;
          console.info(`å•å…ƒåˆ†æå®Œæˆ,è€—æ—¶: ${duration}ms, è®¡ç®—äº† ${resultData.length} ä¸ªå•å…ƒ`);
          
          // ç»Ÿè®¡ä¿¡æ¯
          const qualifiedCount = resultData.filter(d => d.meetsStandard()).length;
          const qualifiedRate = (qualifiedCount / resultData.length * 100).toFixed(1);
          console.info(`è¾¾æ ‡ç‡: ${qualifiedRate}% (${qualifiedCount}/${resultData.length})`);
          
          this.calculating = false;
          this.calculationProgress = '';
          this.totalUnitsToCalculate = 0;
          this.calculatedUnits = 0;
        }
      } catch (error) {
        console.error('è®¡ç®—å•å…ƒæ—¥ç…§æ—¶å‡ºé”™:', JSON.stringify(error));
        this.calculating = false;
        this.calculationProgress = '';
        this.totalUnitsToCalculate = 0;
        this.calculatedUnits = 0;
      }
    };
    
    // å¯åŠ¨ç¬¬ä¸€å—è®¡ç®—
    setTimeout(processChunk, 100);
  }

  /**
   * å¯¼å‡ºæ•°æ®ä¸ºJSONæ ¼å¼
   */
  private exportToJSON(): BuildingExportData {
    const exportData: BuildingExportData = {
      version: '1.0',
      latitude: this.latitude,
      longitude: this.longitude,
      scaleMetersPerCell: this.scaleMetersPerCell,
      nextBuildingId: this.nextBuildingId,
      buildings: this.buildings.map((b: BuildingModel): BuildingJSON => {
        const buildingJSON: BuildingJSON = {
          id: b.id,
          width: b.width,
          length: b.length,
          height: b.height,
          floorHeight: b.floorHeight,
          units: b.units,
          rotationDeg: b.rotationDeg,
          x: b.x,
          y: b.y
        };
        return buildingJSON;
      })
    };
    return exportData;
  }

  /**
   * ä»JSONæ•°æ®å¯¼å…¥
   */
  private importFromJSON(data: BuildingExportData) {
    try {
      this.latitude = data.latitude;
      this.longitude = data.longitude;
      // æ¯”ä¾‹å°ºå›ºå®šä¸º10ç±³,ä¸ä»å¯¼å…¥æ•°æ®ä¸­è¯»å–
      // this.scaleMetersPerCell = data.scaleMetersPerCell;
      this.nextBuildingId = data.nextBuildingId;
      
      this.buildings = data.buildings.map(b => {
        const building = new BuildingModel();
        building.id = b.id;
        building.width = b.width;
        building.length = b.length;
        building.height = b.height;
        building.floorHeight = b.floorHeight;
        building.units = b.units;
        building.rotationDeg = b.rotationDeg;
        building.x = b.x;
        building.y = b.y;
        return building;
      });
      
      this.selectedBuildingId = null;
      this.updateTargetBuildingOptions();
      this.redraw();
      
      console.info(`å¯¼å…¥æˆåŠŸ: ${this.buildings.length} ä¸ªå»ºç­‘ç‰©`);
    } catch (error) {
      console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', JSON.stringify(error));
    }
  }

  /**
   * ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
   */
  private async saveToStorage() {
    try {
      const context = getContext(this);
      const dataPreferences = await preferences.getPreferences(context, 'AdvancedCalculatorData');
      const jsonData = JSON.stringify(this.exportToJSON());
      await dataPreferences.put(this.STORAGE_KEY, jsonData);
      await dataPreferences.flush();
      console.info('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
    } catch (error) {
      console.error('ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', JSON.stringify(error));
    }
  }

  /**
   * ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
   */
  private async loadFromStorage() {
    try {
      const context = getContext(this);
      const dataPreferences = await preferences.getPreferences(context, 'AdvancedCalculatorData');
      const jsonData = await dataPreferences.get(this.STORAGE_KEY, '') as string;
      
      if (jsonData) {
        const data = JSON.parse(jsonData) as BuildingExportData;
        this.importFromJSON(data);
        console.info('ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®æˆåŠŸ');
      } else {
        // æ²¡æœ‰ä¿å­˜çš„æ•°æ®,åˆå§‹åŒ–é»˜è®¤å€¼
        this.loadDefaultBuildings();
        this.updateTargetBuildingOptions();
      }
    } catch (error) {
      console.error('ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¤±è´¥:', JSON.stringify(error));
      // åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å€¼
      this.loadDefaultBuildings();
      this.updateTargetBuildingOptions();
    }
  }

  /**
   * å¯¼å‡ºæ•°æ®åˆ°æ–‡ä»¶
   */
  private async exportData() {
    try {
      const jsonData = JSON.stringify(this.exportToJSON(), null, 2);
      const fileName = `sunshine_buildings_${new Date().getTime()}.json`;
      
      // ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨ä¿å­˜æ–‡ä»¶
      const documentSaveOptions = new picker.DocumentSaveOptions();
      documentSaveOptions.newFileNames = [fileName];
      documentSaveOptions.fileSuffixChoices = ['.json'];
      
      const documentPicker = new picker.DocumentViewPicker();
      const uris = await documentPicker.save(documentSaveOptions);
      
      if (uris && uris.length > 0) {
        const file = fs.openSync(uris[0], fs.OpenMode.WRITE_ONLY | fs.OpenMode.CREATE);
        fs.writeSync(file.fd, jsonData);
        fs.closeSync(file);
        
        console.info(`æ•°æ®å·²å¯¼å‡ºåˆ°: ${uris[0]}`);
        
        // æç¤ºç”¨æˆ·å¯¼å‡ºæˆåŠŸ
        AlertDialog.show({
          title: 'å¯¼å‡ºæˆåŠŸ',
          message: `å»ºç­‘æ•°æ®å·²æˆåŠŸå¯¼å‡º\nå…± ${this.buildings.length} ä¸ªå»ºç­‘ç‰©`,
          confirm: {
            value: 'ç¡®å®š',
            action: () => {}
          }
        });
      }
    } catch (error) {
      console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', JSON.stringify(error));
      AlertDialog.show({
        title: 'å¯¼å‡ºå¤±è´¥',
        message: 'å¯¼å‡ºå»ºç­‘æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯',
        confirm: {
          value: 'ç¡®å®š',
          action: () => {}
        }
      });
    }
  }

  /**
   * ä»æ–‡ä»¶å¯¼å…¥æ•°æ®
   */
  private async importData() {
    try {
      // ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨é€‰æ‹©æ–‡ä»¶
      const documentSelectOptions = new picker.DocumentSelectOptions();
      documentSelectOptions.maxSelectNumber = 1;
      documentSelectOptions.fileSuffixFilters = ['.json'];
      
      const documentPicker = new picker.DocumentViewPicker();
      const uris = await documentPicker.select(documentSelectOptions);
      
      if (uris && uris.length > 0) {
        const file = fs.openSync(uris[0], fs.OpenMode.READ_ONLY);
        const buffer = new ArrayBuffer(10 * 1024 * 1024); // 10MB buffer
        const readLen = fs.readSync(file.fd, buffer);
        fs.closeSync(file);
        
        const jsonData = String.fromCharCode(...new Uint8Array(buffer.slice(0, readLen)));
        const data = JSON.parse(jsonData) as BuildingExportData;
        
        // ç¡®è®¤å¯¼å…¥
        AlertDialog.show({
          title: 'ç¡®è®¤å¯¼å…¥',
          message: `å°†å¯¼å…¥ ${data.buildings.length} ä¸ªå»ºç­‘ç‰©\nå½“å‰æ•°æ®å°†è¢«è¦†ç›–`,
          primaryButton: {
            value: 'å–æ¶ˆ',
            action: () => {}
          },
          secondaryButton: {
            value: 'ç¡®å®š',
            action: () => {
              this.importFromJSON(data);
              AlertDialog.show({
                title: 'å¯¼å…¥æˆåŠŸ',
                message: `å·²æˆåŠŸå¯¼å…¥ ${data.buildings.length} ä¸ªå»ºç­‘ç‰©`,
                confirm: {
                  value: 'ç¡®å®š',
                  action: () => {}
                }
              });
            }
          }
        });
      }
    } catch (error) {
      console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', JSON.stringify(error));
      AlertDialog.show({
        title: 'å¯¼å…¥å¤±è´¥',
        message: 'å¯¼å…¥å»ºç­‘æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯\nè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®',
        confirm: {
          value: 'ç¡®å®š',
          action: () => {}
        }
      });
    }
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰å»ºç­‘ç‰©
   */
  private clearAllBuildings() {
    AlertDialog.show({
      title: 'ç¡®è®¤æ¸…ç©º',
      message: `å°†æ¸…ç©ºæ‰€æœ‰å»ºç­‘ç‰© (å…± ${this.buildings.length} ä¸ª)\næ­¤æ“ä½œä¸å¯æ¢å¤`,
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {}
      },
      secondaryButton: {
        value: 'ç¡®å®š',
        action: () => {
          this.buildings = [];
          this.selectedBuildingId = null;
          this.nextBuildingId = 1;
          this.updateTargetBuildingOptions();
          this.redraw();
          this.saveToStorage();
          console.info('å·²æ¸…ç©ºæ‰€æœ‰å»ºç­‘ç‰©');
        }
      }
    });
  }
}

/**
 * åŸå¸‚é€‰æ‹©å™¨å¯¹è¯æ¡†ç»„ä»¶
 */
@CustomDialog
struct CityPickerDialog {
  controller?: CustomDialogController;
  cities: CityModel[] = [];
  onSelect: (city: CityModel) => void = () => {};
  @State searchText: string = '';
  @State filteredCities: CityModel[] = [];

  aboutToAppear() {
    this.filteredCities = this.cities;
  }

  /**
   * æœç´¢åŸå¸‚
   */
  private filterCities(keyword: string) {
    if (!keyword || keyword.trim() === '') {
      this.filteredCities = this.cities;
    } else {
      const lowerKeyword = keyword.toLowerCase();
      this.filteredCities = this.cities.filter((city: CityModel) => {
        const displayName = city.getDisplayName().toLowerCase();
        const cityName = city.city.toLowerCase();
        const provinceName = city.province.toLowerCase();
        return displayName.includes(lowerKeyword) || 
               cityName.includes(lowerKeyword) || 
               provinceName.includes(lowerKeyword);
      });
    }
  }

  build() {
    Column() {
      // æœç´¢æ¡†
      TextInput({ placeholder: 'æœç´¢åŸå¸‚...', text: this.searchText })
        .width('100%')
        .height(40)
        .margin({ bottom: 10 })
        .backgroundColor($r('app.color.input_background'))
        .borderRadius(8)
        .padding({ left: 15, right: 15 })
        .onChange((text: string) => {
          this.searchText = text;
          this.filterCities(text);
        })

      // åŸå¸‚åˆ—è¡¨
      Scroll() {
        Column() {
          if (this.filteredCities.length === 0) {
            Text('æœªæ‰¾åˆ°åŒ¹é…çš„åŸå¸‚')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ top: 20 })
              .width('100%')
              .textAlign(TextAlign.Center)
          } else {
            ForEach(this.filteredCities, (city: CityModel, index: number) => {
              Row() {
                Text(city.getDisplayName())
                  .fontSize(16)
                  .layoutWeight(1)
              }
              .width('100%')
              .padding(15)
              .backgroundColor(index % 2 === 0 ? $r('app.color.input_background') : $r('app.color.card_background'))
              .onClick(() => {
                this.onSelect(city);
                this.controller?.close();
              })
            })
          }
        }
      }
      .layoutWeight(1)

      // å–æ¶ˆæŒ‰é’®
      Button('å–æ¶ˆ')
        .width('100%')
        .margin({ top: 10 })
        .onClick(() => {
          this.controller?.close();
        })
    }
    .width('90%')
    .height('70%')
    .padding(20)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(10)
  }
}
