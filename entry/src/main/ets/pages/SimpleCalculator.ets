import { HouseInputModel } from '../model/HouseInputModel';
import { HouseSunshineModel } from '../model/HouseSunshineModel';
import { SimpleSunshineCalculator } from '../calculator/SimpleSunshineCalculator';
import { CityModel } from '../model/CityModel';
import { CityDataService } from '../utils/CityDataService';
import { SunshineRatingSystem, RatingResult } from '../utils/SunshineRatingSystem';
import { SunshineRatingCard } from '../components/SunshineRatingCard';
import { SimpleSunshineCharts } from '../components/SimpleSunshineCharts';
import { HistoryManager, SimpleHistoryItem } from '../utils/HistoryManager';
import { SimpleHistoryDialog } from '../components/SimpleHistoryDialog';
import { SaveHistoryDialog } from '../components/SaveHistoryDialog';
import router from '@ohos.router';
import window from '@ohos.window';
import { BusinessError } from '@ohos.base';
import promptAction from '@ohos.promptAction';

/**
 * ç®€å•æ—¥ç…§è¯„ä¼°å™¨é¡µé¢
 */
@Entry
@Component
struct SimpleCalculatorPage {
  @State inputModel: HouseInputModel = new HouseInputModel();
  @State result: HouseSunshineModel = new HouseSunshineModel();
  @State calculating: boolean = false;
  @State showResult: boolean = false;
  @State selectedCity: string = 'è¯·é€‰æ‹©åŸŽå¸‚';
  @State cities: CityModel[] = [];
  @State ratingResult: RatingResult | null = null;
  
  // ä¸ºæ¯ä¸ªè¾“å…¥å­—æ®µç»´æŠ¤æ˜¾ç¤ºå­—ç¬¦ä¸²
  @State longitudeText: string = '';
  @State latitudeText: string = '';
  @State levelText: string = '';
  @State levelHeightText: string = '';
  @State blockLevelText: string = '';
  @State blockLevelHeightText: string = '';
  @State distanceText: string = '';
  @State timeZoneText: string = '';
  @State yearText: string = '';
  
  // å“åº”å¼å¸ƒå±€ç›¸å…³
  @State screenWidth: number = 0;
  @State isTablet: boolean = false;
  
  private cityDialogController: CustomDialogController | null = null;
  private historyDialogController: CustomDialogController | null = null;
  private saveHistoryDialogController: CustomDialogController | null = null;
  private calculator: SimpleSunshineCalculator = new SimpleSunshineCalculator();
  private windowSizeChangeCallback: ((size: window.Size) => void) | null = null;

  aboutToAppear() {
    // åˆå§‹åŒ–åŸŽå¸‚æ•°æ®
    this.cities = CityDataService.getAllCities();
    // åˆå§‹åŒ–æ˜¾ç¤ºæ–‡æœ¬
    this.updateDisplayTexts();
    // èŽ·å–çª—å£å®½åº¦å¹¶æ³¨å†Œç›‘å¬
    this.updateScreenWidth();
    this.registerWindowSizeListener();
  }
  
  aboutToDisappear() {
    // å–æ¶ˆçª—å£å¤§å°å˜åŒ–ç›‘å¬
    this.unregisterWindowSizeListener();
  }
  
  /**
   * æ›´æ–°çª—å£å®½åº¦å’Œåˆ¤æ–­æ˜¯å¦ä¸ºå¹³æ¿
   */
  private updateScreenWidth(): void {
    try {
      // èŽ·å–å½“å‰çª—å£
      let windowClass = window.getLastWindow(this.getUIContext().getHostContext());
      windowClass.then((win: window.Window) => {
        let properties = win.getWindowProperties();
        // å°†pxè½¬æ¢ä¸ºvp
        this.screenWidth = px2vp(properties.windowRect.width);
        // å®½åº¦å¤§äºŽ600vpè®¤ä¸ºæ˜¯å¹³æ¿æˆ–æ¨ªå±
        this.isTablet = this.screenWidth > 600;
        console.info(`çª—å£å®½åº¦æ›´æ–°: ${this.screenWidth}vp, å¹³æ¿æ¨¡å¼: ${this.isTablet}`);
      }).catch((err: BusinessError) => {
        console.error('Failed to get window:', JSON.stringify(err));
        this.screenWidth = 360; // é»˜è®¤æ‰‹æœºå®½åº¦
        this.isTablet = false;
      });
    } catch (err) {
      console.error('Failed to get window width:', JSON.stringify(err));
      this.screenWidth = 360; // é»˜è®¤æ‰‹æœºå®½åº¦
      this.isTablet = false;
    }
  }
  
  /**
   * æ³¨å†Œçª—å£å¤§å°å˜åŒ–ç›‘å¬
   */
  private registerWindowSizeListener(): void {
    try {
      let windowClass = window.getLastWindow(this.getUIContext().getHostContext());
      windowClass.then((win: window.Window) => {
        // åˆ›å»ºçª—å£å¤§å°å˜åŒ–å›žè°ƒ
        this.windowSizeChangeCallback = (size: window.Size) => {
          // å°†pxè½¬æ¢ä¸ºvp
          const newWidth = px2vp(size.width);
          const newIsTablet = newWidth > 600;
          
          // åªåœ¨æ¨¡å¼åˆ‡æ¢æ—¶æ›´æ–°,é¿å…é¢‘ç¹è§¦å‘
          if (this.isTablet !== newIsTablet || Math.abs(this.screenWidth - newWidth) > 10) {
            this.screenWidth = newWidth;
            this.isTablet = newIsTablet;
            console.info(`çª—å£å¤§å°å˜åŒ–: ${this.screenWidth}vp, å¹³æ¿æ¨¡å¼: ${this.isTablet}`);
          }
        };
        
        // æ³¨å†Œç›‘å¬
        win.on('windowSizeChange', this.windowSizeChangeCallback);
        console.info('çª—å£å¤§å°å˜åŒ–ç›‘å¬å·²æ³¨å†Œ');
      }).catch((err: BusinessError) => {
        console.error('Failed to register window size listener:', JSON.stringify(err));
      });
    } catch (err) {
      console.error('Failed to register window size listener:', JSON.stringify(err));
    }
  }
  
  /**
   * å–æ¶ˆçª—å£å¤§å°å˜åŒ–ç›‘å¬
   */
  private unregisterWindowSizeListener(): void {
    try {
      if (this.windowSizeChangeCallback) {
        let windowClass = window.getLastWindow(this.getUIContext().getHostContext());
        windowClass.then((win: window.Window) => {
          win.off('windowSizeChange', this.windowSizeChangeCallback!);
          this.windowSizeChangeCallback = null;
          console.info('çª—å£å¤§å°å˜åŒ–ç›‘å¬å·²å–æ¶ˆ');
        }).catch((err: BusinessError) => {
          console.error('Failed to unregister window size listener:', JSON.stringify(err));
        });
      }
    } catch (err) {
      console.error('Failed to unregister window size listener:', JSON.stringify(err));
    }
  }
  
  /**
   * æ›´æ–°æ‰€æœ‰æ˜¾ç¤ºæ–‡æœ¬
   */
  private updateDisplayTexts() {
    this.longitudeText = this.inputModel.longitude.toFixed(6);
    this.latitudeText = this.inputModel.latitude.toFixed(6);
    this.levelText = this.inputModel.level.toString();
    this.levelHeightText = this.inputModel.levelHeight.toFixed(2);
    this.blockLevelText = this.inputModel.blockLevel.toString();
    this.blockLevelHeightText = this.inputModel.blockLevelHeight.toFixed(2);
    this.distanceText = this.inputModel.distance.toString();
    this.timeZoneText = this.inputModel.timeZone.toString();
    this.yearText = this.inputModel.year.toString();
  }

  build() {
    Stack() {
      Column() {
        // æ ‡é¢˜æ  - æ·»åŠ è¿”å›žæŒ‰é’®
        Row() {
          Button() {
            Text('â†')
              .fontSize(24)
              .fontColor(Color.White)
          }
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.getUIContext().getRouter().back();
          })
          .margin({ left: 8 })

          Text('åŸºç¡€æ—¥ç…§è¯„ä¼°å™¨')
            .fontSize(20)
            .fontWeight(FontWeight.Medium)
            .fontColor(Color.White)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
          
          // åŽ†å²è®°å½•æŒ‰é’®
          Button() {
            Text('ðŸ“‹')
              .fontSize(20)
          }
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .width(40)
          .height(40)
          .onClick(() => {
            this.showHistoryDialog();
          })
          .margin({ right: 8 })
        }
        .width('100%')
        .height(56)
        .backgroundColor('#1976D2')
        .padding({ left: 8, right: 8 })
        .alignItems(VerticalAlign.Center)

        Scroll() {
          Column() {
            // æ ¹æ®è®¾å¤‡å®½åº¦é€‰æ‹©å¸ƒå±€æ–¹å¼
            if (this.isTablet) {
              // å¹³æ¿å¸ƒå±€ï¼šå·¦å³åˆ†æ 
              this.buildTabletLayout()
            } else {
              // æ‰‹æœºå¸ƒå±€ï¼šåž‚ç›´æŽ’åˆ—
              this.buildPhoneLayout()
            }
          }
          .width('100%')
          .padding(this.isTablet ? 40 : 20)
        }
        .layoutWeight(1)
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.page_background'))

      // åŠ è½½é®ç½©å±‚
      if (this.calculating) {
        this.buildLoadingMask()
      }
    }
    .width('100%')
    .height('100%')
  }
  
  /**
   * åŠ è½½é®ç½©å±‚
   */
  @Builder
  buildLoadingMask() {
    Column() {
      Column() {
        LoadingProgress()
          .width(80)
          .height(80)
          .color($r('app.color.link_color'))
          .margin({ bottom: 20 })
        
        Text('æ­£åœ¨è®¡ç®—æ—¥ç…§æ—¶é—´...')
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
          .margin({ bottom: 10 })
        
        Text('è¯·ç¨å€™,è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
      }
      .width(280)
      .padding(30)
      .backgroundColor($r('app.color.card_background'))
      .borderRadius(16)
      .shadow({
        radius: 20,
        color: 'rgba(0, 0, 0, 0.1)',
        offsetX: 0,
        offsetY: 4
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('rgba(0, 0, 0, 0.4)')
    .justifyContent(FlexAlign.Center)
  }
  
  /**
   * æ‰‹æœºå¸ƒå±€ï¼šåž‚ç›´æŽ’åˆ—
   */
  @Builder
  buildPhoneLayout() {
    Column() {
      // è¾“å…¥å‚æ•°åŒºåŸŸ
      this.buildInputSection()

      // è®¡ç®—æŒ‰é’®
      Button('è®¡ç®—æ—¥ç…§æ—¶é—´')
        .width('90%')
        .height(50)
        .margin({ top: 30 })
        .fontSize(18)
        .enabled(!this.calculating)
        .onClick(() => {
          this.calculateSunshine();
        })

      // ç»“æžœæ˜¾ç¤ºåŒºåŸŸ
      if (this.showResult) {
        this.buildResultSection()
      }
    }
    .width('100%')
  }
  
  /**
   * å¹³æ¿å¸ƒå±€ï¼šå·¦å³åˆ†æ 
   */
  @Builder
  buildTabletLayout() {
    Row() {
      // å·¦ä¾§ï¼šè¾“å…¥å‚æ•°
      Column() {
        this.buildInputSection()
        
        // è®¡ç®—æŒ‰é’®
        Button('è®¡ç®—æ—¥ç…§æ—¶é—´')
          .width('80%')
          .height(50)
          .margin({ top: 30 })
          .fontSize(18)
          .enabled(!this.calculating)
          .onClick(() => {
            this.calculateSunshine();
          })
      }
      .width('45%')
      .padding(20)
      .backgroundColor($r('app.color.card_background'))
      .borderRadius(12)
      
      Blank().width(40)
      
      // å³ä¾§ï¼šç»“æžœæ˜¾ç¤º
      Column() {
        if (this.showResult) {
          this.buildResultSection()
        } else {
          // å ä½æç¤º
          Column() {
            Image($r('sys.symbol.sun_max'))
              .width(80)
              .height(80)
              .fillColor($r('app.color.text_secondary'))
              .margin({ bottom: 20 })
            
            Text('è¾“å…¥å‚æ•°åŽç‚¹å‡»è®¡ç®—')
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
            
            Text('ç»“æžœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ top: 10 })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('45%')
      .padding(20)
      .backgroundColor($r('app.color.card_background'))
      .borderRadius(12)
      .layoutWeight(1)
    }
    .width('100%')
    .alignItems(VerticalAlign.Top)
  }

  @Builder
  buildInputSection() {
    Column() {
      Text('å‚æ•°è®¾ç½®')
        .fontSize(20)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 15 })
        .alignSelf(ItemAlign.Start)

      // åŸŽå¸‚é€‰æ‹©
      Row() {
        Text('é€‰æ‹©åŸŽå¸‚')
          .fontSize(16)
          .width('40%')

        Button(this.selectedCity)
          .width('60%')
          .onClick(() => {
            this.showCityPickerDialog();
          })
      }
      .width('100%')
      .margin({ bottom: 10 })

      // ç»çº¬åº¦ (åè¿›åˆ¶æ ¼å¼)
      // ç»åº¦
      Row() {
        Text('ç»åº¦')
          .fontSize(16)
          .width('40%')

        TextInput({ text: this.longitudeText })
          .width('60%')
          .type(InputType.NUMBER_DECIMAL)
          .onChange((text: string) => {
            this.longitudeText = text;
            const num = parseFloat(text);
            if (!isNaN(num) && num >= -180 && num <= 180) {
              this.inputModel.longitude = num;
            }
          })
      }
      .width('100%')
      .margin({ bottom: 10 })
      .alignItems(VerticalAlign.Center)

      // çº¬åº¦
      Row() {
        Text('çº¬åº¦')
          .fontSize(16)
          .width('40%')

        TextInput({ text: this.latitudeText })
          .width('60%')
          .type(InputType.NUMBER_DECIMAL)
          .onChange((text: string) => {
            this.latitudeText = text;
            const num = parseFloat(text);
            if (!isNaN(num) && num >= -90 && num <= 90) {
              this.inputModel.latitude = num;
            }
          })
      }
      .width('100%')
      .margin({ bottom: 10 })
      .alignItems(VerticalAlign.Center)

      // æ‰€åœ¨æ¥¼å±‚
      Row() {
        Text('æ‰€åœ¨æ¥¼å±‚')
          .fontSize(16)
          .width('40%')

        TextInput({ text: this.levelText })
          .width('60%')
          .type(InputType.Number)
          .onChange((text: string) => {
            this.levelText = text;
            const num = parseInt(text);
            if (!isNaN(num) && num >= 1 && num <= 100) {
              this.inputModel.level = num;
            }
          })
      }
      .width('100%')
      .margin({ bottom: 10 })
      .alignItems(VerticalAlign.Center)

      // å±‚é«˜
      Row() {
        Text('å±‚é«˜(ç±³)')
          .fontSize(16)
          .width('40%')

        TextInput({ text: this.levelHeightText })
          .width('60%')
          .type(InputType.NUMBER_DECIMAL)
          .onChange((text: string) => {
            this.levelHeightText = text;
            const num = parseFloat(text);
            if (!isNaN(num) && num >= 2.5 && num <= 5) {
              this.inputModel.levelHeight = num;
            }
          })
      }
      .width('100%')
      .margin({ bottom: 10 })
      .alignItems(VerticalAlign.Center)

      // é®æŒ¡æ¥¼æ ‹å±‚æ•°
      Row() {
        Text('é®æŒ¡æ¥¼æ ‹å±‚æ•°')
          .fontSize(16)
          .width('40%')

        TextInput({ text: this.blockLevelText })
          .width('60%')
          .type(InputType.Number)
          .onChange((text: string) => {
            this.blockLevelText = text;
            const num = parseInt(text);
            if (!isNaN(num) && num >= 1 && num <= 100) {
              this.inputModel.blockLevel = num;
            }
          })
      }
      .width('100%')
      .margin({ bottom: 10 })
      .alignItems(VerticalAlign.Center)

      // é®æŒ¡æ¥¼æ ‹å±‚é«˜
      Row() {
        Text('é®æŒ¡æ¥¼æ ‹å±‚é«˜(ç±³)')
          .fontSize(16)
          .width('40%')

        TextInput({ text: this.blockLevelHeightText })
          .width('60%')
          .type(InputType.NUMBER_DECIMAL)
          .onChange((text: string) => {
            this.blockLevelHeightText = text;
            const num = parseFloat(text);
            if (!isNaN(num) && num >= 2.5 && num <= 5) {
              this.inputModel.blockLevelHeight = num;
            }
          })
      }
      .width('100%')
      .margin({ bottom: 10 })
      .alignItems(VerticalAlign.Center)

      // è·ç¦»é®æŒ¡æ¥¼æ ‹
      Row() {
        Text('è·ç¦»é®æŒ¡æ¥¼æ ‹(ç±³)')
          .fontSize(16)
          .width('40%')

        TextInput({ text: this.distanceText })
          .width('60%')
          .type(InputType.Number)
          .onChange((text: string) => {
            this.distanceText = text;
            const num = parseFloat(text);
            if (!isNaN(num) && num >= 10 && num <= 200) {
              this.inputModel.distance = num;
            }
          })
      }
      .width('100%')
      .margin({ bottom: 10 })
      .alignItems(VerticalAlign.Center)

      // æ—¶åŒº
      Row() {
        Text('æ—¶åŒº')
          .fontSize(16)
          .width('40%')

        TextInput({ text: this.timeZoneText })
          .width('60%')
          .type(InputType.Number)
          .onChange((text: string) => {
            this.timeZoneText = text;
            const num = parseInt(text);
            if (!isNaN(num) && num >= -12 && num <= 12) {
              this.inputModel.timeZone = num;
            }
          })
      }
      .width('100%')
      .margin({ bottom: 10 })
      .alignItems(VerticalAlign.Center)

      // å¹´ä»½
      Row() {
        Text('å¹´ä»½')
          .fontSize(16)
          .width('40%')

        TextInput({ text: this.yearText })
          .width('60%')
          .type(InputType.Number)
          .onChange((text: string) => {
            this.yearText = text;
            const num = parseInt(text);
            if (!isNaN(num) && num >= 2020 && num <= 2030) {
              this.inputModel.year = num;
            }
          })
      }
      .width('100%')
      .margin({ bottom: 10 })
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .padding(15)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(10)
  }

  @Builder
  buildResultSection() {
    Column() {
      Text('è®¡ç®—ç»“æžœ')
        .fontSize(20)
        .fontWeight(FontWeight.Medium)
        .margin({ top: 30, bottom: 15 })
        .alignSelf(ItemAlign.Start)

      // è¯„åˆ†å¡ç‰‡
      if (this.ratingResult) {
        SunshineRatingCard({ ratingResult: this.ratingResult })
          .margin({ bottom: 20 })
      }

      Column() {
        this.buildResultRow('å…¨å¹´æ€»æ—¥ç…§æ—¶é—´', this.result.formatMinutesToHours(this.result.totalSunshineTime) + ' å°æ—¶')
        this.buildResultRow('å…¨å¹´æœ‰æ•ˆæ—¥ç…§æ—¶é—´', this.result.formatMinutesToHours(this.result.exactSunshineTime) + ' å°æ—¶')
        this.buildResultRow('æ˜¥åˆ†æ—¥ç…§æ—¶é—´', this.result.formatMinutesToHours(this.result.springEquinox) + ' å°æ—¶')
        this.buildResultRow('å¤è‡³æ—¥ç…§æ—¶é—´', this.result.formatMinutesToHours(this.result.summerSolstice) + ' å°æ—¶')
        this.buildResultRow('ç§‹åˆ†æ—¥ç…§æ—¶é—´', this.result.formatMinutesToHours(this.result.autumnalEquinox) + ' å°æ—¶')
        this.buildResultRow('å†¬è‡³æ—¥ç…§æ—¶é—´', this.result.formatMinutesToHours(this.result.winterSolstice) + ' å°æ—¶')
        this.buildResultRow('å¤§å¯’æ—¥ç…§æ—¶é—´', this.result.formatMinutesToHours(this.result.greatCold) + ' å°æ—¶')
        this.buildResultRow('æ—¥ç…§æ—¶é—´ç™¾åˆ†æ¯”', this.result.getSunshinePercent() + ' %')
      }
      .width('100%')
      .padding(15)
      .backgroundColor($r('app.color.card_background'))
      .borderRadius(10)

      // æ—¥ç…§æ—¶é—´å¯è§†åŒ–å›¾è¡¨
      SimpleSunshineCharts({ result: this.result })

      // éªŒè¯ç»“æžœ
      Row() {
        Text(this.calculator.getValidationDescription(this.result))
          .fontSize(16)
          .fontColor(this.calculator.validateSunshineResult(this.result) ? Color.Green : Color.Red)
          .padding(15)
      }
      .width('100%')
      .margin({ top: 15 })
      .backgroundColor(this.calculator.validateSunshineResult(this.result) ? 
        $r('app.color.success_background') : $r('app.color.error_background'))
      .borderRadius(10)
      
      // ä¿å­˜åŽ†å²è®°å½•æŒ‰é’®
      Button('ä¿å­˜åˆ°åŽ†å²è®°å½•')
        .width('100%')
        .margin({ top: 20 })
        .backgroundColor('#007DFF')
        .fontColor(Color.White)
        .onClick(() => {
          this.showSaveHistoryDialog();
        })
    }
    .width('100%')
  }

  @Builder
  buildResultRow(label: string, value: string) {
    Row() {
      Text(label)
        .fontSize(16)
        .width('50%')

      Text(value)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .width('50%')
        .textAlign(TextAlign.End)
    }
    .width('100%')
    .margin({ bottom: 10 })
  }

  /**
   * æ˜¾ç¤ºåŸŽå¸‚é€‰æ‹©å¯¹è¯æ¡†
   */
  private showCityPickerDialog() {
    this.cityDialogController = new CustomDialogController({
      builder: CityPickerDialog({
        cities: this.cities,
        onSelect: (city: CityModel) => {
          this.selectCity(city);
        }
      }),
      autoCancel: true,
      alignment: DialogAlignment.Center,
      customStyle: true,
      maskColor: 'rgba(0, 0, 0, 0.5)' // æ·»åŠ åŠé€æ˜Žé»‘è‰²è’™æ¿
    });
    this.cityDialogController.open();
  }

  /**
   * é€‰æ‹©åŸŽå¸‚
   */
  private selectCity(city: CityModel) {
    // æ›´æ–°é€‰ä¸­çš„åŸŽå¸‚åç§°
    this.selectedCity = city.getDisplayName();
    
    // æ›´æ–°ç»çº¬åº¦åˆ°æ¨¡åž‹
    this.inputModel.longitude = city.getLongitudeDecimal();
    this.inputModel.latitude = city.getLatitudeDecimal();
    
    // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬ - ç›´æŽ¥èµ‹å€¼ä¼šè§¦å‘ @State æ›´æ–°
    this.longitudeText = this.inputModel.longitude.toFixed(6);
    this.latitudeText = this.inputModel.latitude.toFixed(6);
    
    console.info(`é€‰æ‹©åŸŽå¸‚: ${city.getDisplayName()}, ç»åº¦: ${this.longitudeText}, çº¬åº¦: ${this.latitudeText}`);
  }

  /**
   * è®¡ç®—æ—¥ç…§
   */
  private calculateSunshine() {
    // åœ¨è®¡ç®—å‰,ç¡®ä¿ä»Žç•Œé¢æ–‡æœ¬åŒæ­¥æ‰€æœ‰å€¼åˆ° inputModel
    this.syncTextToModel();
    
    this.calculating = true;
    this.showResult = false;

    // ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡é¿å…é˜»å¡žUIçº¿ç¨‹
    // å…ˆç­‰å¾…100msè®©é®ç½©å±‚æ˜¾ç¤ºå‡ºæ¥
    setTimeout(() => {
      const startTime = Date.now();
      try {
        // ä½¿ç”¨1åˆ†é’Ÿæ­¥é•¿è¿›è¡Œç²¾ç¡®è®¡ç®—
        this.result = this.calculator.calculateHouseSunshine(this.inputModel, 1);
        
        // è®¡ç®—è¯„åˆ† (å°†åˆ†é’Ÿè½¬æ¢ä¸ºå°æ—¶)
        this.ratingResult = SunshineRatingSystem.evaluateSimple(
          this.result.exactSunshineTime / 60, // å…¨å¹´æ€»æ—¥ç…§(å°æ—¶)
          this.result.greatCold / 60, // å¤§å¯’(å°æ—¶)
          this.result.winterSolstice / 60, // å†¬è‡³(å°æ—¶)
          this.result.exactSunshineTime / 60 / 365 // å¹´å¹³å‡æ¯æ—¥(å°æ—¶)
        );
        
        this.showResult = true;
        
        const duration = Date.now() - startTime;
        console.info(`è®¡ç®—å®Œæˆ,è€—æ—¶: ${duration}ms, æ­¥é•¿: 1åˆ†é’Ÿ, ` +
                     `ç»åº¦: ${this.inputModel.longitude}, çº¬åº¦: ${this.inputModel.latitude}`);
      } catch (error) {
        console.error('è®¡ç®—æ—¥ç…§æ—¶å‡ºé”™:', error);
        // TODO: æ˜¾ç¤ºé”™è¯¯æç¤º
      } finally {
        this.calculating = false;
      }
    }, 100);
  }

  // æ˜¾ç¤ºåŽ†å²è®°å½•å¯¹è¯æ¡†
  private showHistoryDialog() {
    if (!this.historyDialogController) {
      this.historyDialogController = new CustomDialogController({
        builder: SimpleHistoryDialog({
          onLoad: (item: SimpleHistoryItem) => {
            this.loadHistoryItem(item);
          },
          onClose: () => {
            this.historyDialogController?.close();
          }
        }),
        autoCancel: true,
        alignment: DialogAlignment.Center,
        customStyle: true
      });
    }
    this.historyDialogController.open();
  }

  // åŠ è½½åŽ†å²è®°å½•é¡¹
  private async loadHistoryItem(item: SimpleHistoryItem) {
    // å…³é—­åŽ†å²å¯¹è¯æ¡†
    this.historyDialogController?.close();
    
    // æ¢å¤æ‰€æœ‰è¾“å…¥å‚æ•°
    this.inputModel.blockLevel = item.blockLevel;
    this.inputModel.blockLevelHeight = item.blockLevelHeight;
    this.inputModel.distance = item.distance;
    this.inputModel.latitude = item.latitude;
    this.inputModel.level = item.level;
    this.inputModel.levelHeight = item.levelHeight;
    this.inputModel.longitude = item.longitude;
    this.inputModel.timeZone = item.timeZone;
    this.inputModel.year = item.year;
    
    // æ›´æ–°åŸŽå¸‚ä¿¡æ¯
    const city = this.cities.find(c => c.city === item.cityName);
    if (city) {
      this.selectCity(city);
    }
    
    // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
    this.updateDisplayTexts();
    
    // è‡ªåŠ¨è®¡ç®—
    this.calculateSunshine();
  }

  // ä¿å­˜å½“å‰é…ç½®ä¸ºåŽ†å²è®°å½•
  private showSaveHistoryDialog() {
    if (!this.saveHistoryDialogController) {
      this.saveHistoryDialogController = new CustomDialogController({
        builder: SaveHistoryDialog({
          onSave: (name: string) => {
            this.saveHistory(name);
          },
          onClose: () => {
            this.saveHistoryDialogController?.close();
          }
        }),
        autoCancel: true,
        alignment: DialogAlignment.Center,
        customStyle: true
      });
    }
    this.saveHistoryDialogController.open();
  }

  // æ‰§è¡Œä¿å­˜åŽ†å²è®°å½•
  private async saveHistory(name: string) {
    // å…³é—­ä¿å­˜å¯¹è¯æ¡†
    this.saveHistoryDialogController?.close();
    
    // ç¡®ä¿æœ‰è®¡ç®—ç»“æžœ
    if (!this.showResult) {
      // æç¤ºç”¨æˆ·å…ˆè¿›è¡Œè®¡ç®—
      promptAction.showToast({ message: 'è¯·å…ˆè¿›è¡Œæ—¥ç…§è®¡ç®—åŽå†ä¿å­˜' });
      return;
    }
    
    // èŽ·å–åŸŽå¸‚åç§°
    let cityName = 'æœªçŸ¥';
    const city = this.cities.find(c => parseFloat(c.lng) === this.inputModel.longitude && parseFloat(c.lat) === this.inputModel.latitude);
    if (city) {
      cityName = city.city;
    }
    
    // æž„å»ºåŽ†å²è®°å½•é¡¹
    const historyItem: SimpleHistoryItem = {
      id: Date.now().toString(),
      name: name || `è®°å½•-${new Date().toLocaleString('zh-CN')}`,
      timestamp: Date.now(),
      cityName: cityName,
      blockLevel: this.inputModel.blockLevel,
      blockLevelHeight: this.inputModel.blockLevelHeight,
      distance: this.inputModel.distance,
      latitude: this.inputModel.latitude,
      level: this.inputModel.level,
      levelHeight: this.inputModel.levelHeight,
      longitude: this.inputModel.longitude,
      timeZone: this.inputModel.timeZone,
      year: this.inputModel.year,
      totalSunshine: this.result.exactSunshineTime / 60, // è½¬ä¸ºå°æ—¶
      winterSolsticeSunshine: this.result.winterSolstice / 60,
      greatColdSunshine: this.result.greatCold / 60,
      averageDailySunshine: this.result.exactSunshineTime / 60 / 365,
      score: this.ratingResult?.score || 0
    };
    
    // ä¿å­˜åˆ°åŽ†å²è®°å½•
    const context = getContext(this) as Context;
    await HistoryManager.saveSimpleHistory(context, historyItem);
    
    // æ˜¾ç¤ºæˆåŠŸæç¤º
    promptAction.showToast({ message: 'åŽ†å²è®°å½•å·²ä¿å­˜' });
  }

  /**
   * å°†ç•Œé¢æ˜¾ç¤ºçš„æ–‡æœ¬åŒæ­¥åˆ° inputModel
   */
  private syncTextToModel() {
    // åŒæ­¥ç»çº¬åº¦
    const longitude = parseFloat(this.longitudeText);
    if (!isNaN(longitude) && longitude >= -180 && longitude <= 180) {
      this.inputModel.longitude = longitude;
    }
    
    const latitude = parseFloat(this.latitudeText);
    if (!isNaN(latitude) && latitude >= -90 && latitude <= 90) {
      this.inputModel.latitude = latitude;
    }
    
    // åŒæ­¥å…¶ä»–å­—æ®µ
    const level = parseInt(this.levelText);
    if (!isNaN(level)) {
      this.inputModel.level = level;
    }
    
    const levelHeight = parseFloat(this.levelHeightText);
    if (!isNaN(levelHeight)) {
      this.inputModel.levelHeight = levelHeight;
    }
    
    const blockLevel = parseInt(this.blockLevelText);
    if (!isNaN(blockLevel)) {
      this.inputModel.blockLevel = blockLevel;
    }
    
    const blockLevelHeight = parseFloat(this.blockLevelHeightText);
    if (!isNaN(blockLevelHeight)) {
      this.inputModel.blockLevelHeight = blockLevelHeight;
    }
    
    const distance = parseFloat(this.distanceText);
    if (!isNaN(distance)) {
      this.inputModel.distance = distance;
    }
    
    const timeZone = parseInt(this.timeZoneText);
    if (!isNaN(timeZone)) {
      this.inputModel.timeZone = timeZone;
    }
    
    const year = parseInt(this.yearText);
    if (!isNaN(year)) {
      this.inputModel.year = year;
    }
  }
}

// åŸŽå¸‚é€‰æ‹©å™¨å¯¹è¯æ¡†ç»„ä»¶
@CustomDialog
struct CityPickerDialog {
  controller?: CustomDialogController;
  cities: CityModel[] = [];
  onSelect: (city: CityModel) => void = () => {};
  @State searchText: string = '';
  @State filteredCities: CityModel[] = [];

  aboutToAppear() {
    this.filteredCities = this.cities;
  }

  /**
   * æœç´¢åŸŽå¸‚
   */
  private filterCities(keyword: string) {
    if (!keyword || keyword.trim() === '') {
      this.filteredCities = this.cities;
    } else {
      const lowerKeyword = keyword.toLowerCase();
      this.filteredCities = this.cities.filter((city: CityModel) => {
        const displayName = city.getDisplayName().toLowerCase();
        const cityName = city.city.toLowerCase();
        const provinceName = city.province.toLowerCase();
        return displayName.includes(lowerKeyword) || 
               cityName.includes(lowerKeyword) || 
               provinceName.includes(lowerKeyword);
      });
    }
  }

  build() {
    Column() {
      // æœç´¢æ¡†
      TextInput({ placeholder: 'æœç´¢åŸŽå¸‚...', text: this.searchText })
        .width('100%')
        .height(40)
        .margin({ bottom: 10 })
        .backgroundColor($r('app.color.input_background'))
        .borderRadius(8)
        .padding({ left: 15, right: 15 })
        .onChange((text: string) => {
          this.searchText = text;
          this.filterCities(text);
        })

      // åŸŽå¸‚åˆ—è¡¨
      Scroll() {
        Column() {
          if (this.filteredCities.length === 0) {
            Text('æœªæ‰¾åˆ°åŒ¹é…çš„åŸŽå¸‚')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ top: 20 })
              .width('100%')
              .textAlign(TextAlign.Center)
          } else {
            ForEach(this.filteredCities, (city: CityModel, index: number) => {
              Row() {
                Text(city.getDisplayName())
                  .fontSize(16)
                  .layoutWeight(1)
              }
              .width('100%')
              .padding(15)
              .backgroundColor(index % 2 === 0 ? $r('app.color.input_background') : $r('app.color.card_background'))
              .onClick(() => {
                this.onSelect(city);
                this.controller?.close();
              })
            })
          }
        }
      }
      .layoutWeight(1)

      // å–æ¶ˆæŒ‰é’®
      Button('å–æ¶ˆ')
        .width('100%')
        .margin({ top: 10 })
        .onClick(() => {
          this.controller?.close();
        })
    }
    .width('90%')
    .height('70%')
    .padding(20)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(10)
  }
}
